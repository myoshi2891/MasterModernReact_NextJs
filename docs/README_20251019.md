# 開発環境トラブルシュート & 改善サマリー（2025-10-19）

本ファイルは、**Next.js + Docker + Supabase(Postgres)** の開発環境で発生していた各種問題の調査・対処・改善策を **1 日分**としてまとめたものです。最終版の Dockerfile / Compose（dev/prod）と運用上のコツ、チェックリストを含みます。

---

## 1. 発端：画面遷移が極端に遅い（Docker 上の Next dev）

### 主因（優先度順）

- **アーキ強制のミスマッチ**：`platform: linux/arm64/v8` を固定 → ホストが amd64 の場合 **QEMU エミュレーション**で極端に遅い。
  → 対策：**開発 compose では `platform:` を未指定**にしてホストに自動一致。

- **bind mount の I/O 待ち**：mac/Win の Docker Desktop は小さいファイル多数の監視が苦手。Next dev の再変換で遅延。
  → 対策：**`develop.watch`（compose watch）でファイル同期**し、`/app` は **named volume** に。

- **`node_modules` の volume マスク**：Compose で `/app/node_modules` を volume にすると、イメージ内で入れた依存が起動時に **空でマスク**され、都度解決で遅い。
  → 対策：**初回のみウォームアップ**（イメージに焼き込み → 空ならコピー）。

- **dev で体感評価**：HMR/型検査等で重い。**prod（`next build` → `next start`）で体感比較**を実施。

---

## 2. 具体的な構成の提供（dev 用 / watch 同期）

- `Dockerfile`（開発用）：`npm ci` → **焼き込み `/opt/node_modules.baked`** → 非 root `nodeapp`。
- `docker-compose.yml`（ベース）：Postgres（Supabase イメージ）定義のみ。
- `docker-compose.dev.yml`：
  - `web-src:/app`（**本体**）・`web-node-modules:/app/node_modules`・`web-next-cache:/app/.next` を **named volume** 化。
  - `develop.watch` で **ホスト →/app に同期**（ignore: `node_modules` / `.next` / `dist` / `coverage` など）。
  - 起動は **フォアグラウンド `up --watch`**（`-d` と併用不可）。

**起動例：**

```bash
docker compose -f docker-compose.yml -f docker-compose.dev.yml up --build --watch
# 別ターミナルで
docker compose -f docker-compose.yml -f docker-compose.dev.yml exec web bash -lc 'ls -la /app | head'
```

---

## 3. 発生エラーと対処

### 3.1 `Export encountered errors on following paths: ...`

- **原因**：静的エクスポート（`output: 'export'` / `next export`）と動的ルート/エラーページの不整合。
- **対処**：SSR 運用なら **`output: 'export'` を無効**。静的化するなら `generateStaticParams` 等で全パス列挙が必要。

### 3.2 Postgres: `FATAL: could not write lock file "postmaster.pid": No space left on device`

- **原因**：DB ボリュームではなく **Docker ディスク全体の枯渇**（イメージ・ビルドキャッシュが肥大）。
- **対処**：
  - `docker builder prune -af`
  - `docker image prune -af`
  - 未使用 volume 削除（Links=0 のみ）
  - 必要なら Docker Desktop の **Disk image size** 拡張。

### 3.3 `service "web" is not running` / `no such service: web`

- **原因**：`web` を定義する dev ファイルを付けずに操作 / 異なる「世界線」で実行。
- **対処**：**すべてのコマンドに同じ `-f docker-compose.yml -f docker-compose.dev.yml`** を付ける。

### 3.4 `--detach cannot be combined with --watch`

- **原因**：`--watch` は前面専用。
- **対処**：フォアグラウンド `up --watch`、または `up -d` の後に別プロセスで `compose watch` 実行。

### 3.5 Next 起動直後に `Couldn't find any pages or app`

- **原因**：`/app`（named volume）が**空のまま**で Next が先に起動。
- **対処**：
  - **初回プリウォーム**（ホスト →`/app` に一括コピー）
  - もしくは一時的に **bind mount** に戻して起動 → 安定後 watch へ復帰。

### 3.6 `EACCES: permission denied, mkdir '/home/nodeapp'`

- **原因**：`nodeapp` のホーム未作成 → SWC ダウンロード先に書けない。
- **対処**：
  - Dockerfile で `useradd --create-home` と `ENV HOME=/home/nodeapp` を設定。
  - 応急：`exec -u root` で `/home/nodeapp` 作成＆ `chown`。

### 3.7 `Failed to load SWC binary for linux/x64`

- **原因**：**SWC のアーキ不一致**（`node_modules` volume に以前の arm64/x64 の成果物が残存）。
- **対処**：
  - `web-node-modules`（必要なら `.next`）を削除 → **ホストのアーキで `build --no-cache`** → 起動。
  - 基本原則：**ビルドと実行のアーキは一致**。アーキを跨ぐ際は `node_modules` volume を捨てる。

---

## 4. 訂正版ファイル（確定版）

### 4.1 Dockerfile（dev ベース）

- `useradd --create-home` と `ENV HOME=/home/nodeapp` を追加。
- `start-dev.sh` で **node_modules ウォームアップ**＋**初回同期待ち（最長 60 秒）**。

### 4.2 docker-compose.yml（ベース）

- Postgres（Supabase 公式イメージ）定義のみ。

### 4.3 docker-compose.dev.yml（開発用）

- `web-src:/app`（本体） + `develop.watch` 同期。
- `web-node-modules` と `web-next-cache` を分離 volume 化。

---

## 5. prod 用プロファイル（`next build` → `next start`）

### 5.1 マルチステージ Dockerfile（追記）

- `prod-build`：依存インストール → `next build`。
- `prod-runtime`：`npm ci --omit=dev` → `.next` / `public` など実行最小セットのみコピー。
- `USER nodeapp` で実行、`CMD ["npm","run","start","--","-H","0.0.0.0","-p","3000"]`。

### 5.2 docker-compose.prod.yml

- `build.target: prod-runtime`。
- **volumes は付けない**（再現性確保／開発ボリュームのマスク事故防止）。
- `NEXT_PUBLIC_*` は **ビルド時注入**が必要（`--build-arg` または `.env.production` をイメージに含める）。

**実行例：**

```bash
docker compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

---

## 6. 定期メンテ & 運用のコツ

- **ディスク掃除（開発）**
  ```bash
  docker builder prune -af && docker image prune -af && docker volume prune -f
  docker system df
  ```
- **アーキ一致の徹底**：`platform:` **未指定**でホストに合わせる。
- **watch 運用**：`--watch` は前面で。バックグラウンド時は `up -d` の後に `compose watch`。
- **prod 検証**：本番は **イメージにソース取り込み**（volumes 不使用）。
- **エラー時の初動**：`ps` → `logs --no-color web | tail -n 200` → `exec` で中身確認。

---

## 7. 便利スニペット

### 7.1 初回プリウォーム（/app が空対策）

```bash
VOL=$(docker volume ls -q | grep web-src)
docker run --rm -v "$VOL":/app -v "$PWD":/host alpine sh -lc '  cd /host &&   tar --exclude=node_modules --exclude=.next --exclude=.git --exclude=dist --exclude=build       --exclude=coverage --exclude=playwright-report --exclude=test-results --exclude=.playwright       -cf - . | tar -C /app -xf -'
```

### 7.2 SWC 不一致時の復旧

```bash
docker compose -f docker-compose.yml -f docker-compose.dev.yml down
docker volume rm mastermodernreact_nextjs_web-node-modules || true
docker volume rm mastermodernreact_nextjs_web-next-cache || true
docker compose -f docker-compose.yml -f docker-compose.dev.yml build --no-cache web
docker compose -f docker-compose.yml -f docker-compose.dev.yml up --watch
```

---

## 8. まとめ（今日の成果）

- 遅延の主要因（エミュレーション / bind mount I/O / node_modules マスク）を特定し、**watch 同期 + volume 設計**で解消。
- 一連の **起動失敗（no such service / not running / EACCES / SWC mismatch）** を再現 → 原因切り分け → **恒久対策を反映**。
- **prod プロファイル**（`next build` → `next start`）と **マルチステージ Dockerfile** を提供。
- 今後の再発を防ぐための **手順・コマンド・運用の原則** を README として整備。

---

## 9. 追加対応の詳細（追記：2025-10-19）

本日この後に発生・解消した事項を追記します。**Edge Runtime 警告の解消**、**環境変数の注入タイミング**、**Server/Browser クライアントの分離**、**型エラーの修正**、**Server Actions の指針** などを整理しました。

### 9.1 Edge Runtime 警告の解消（@supabase/supabase-js は Edge 非対応）

- 現象: `A Node.js API is used ... not supported in the Edge Runtime.`（import trace は supabase 関連）
- 原因: `@supabase/supabase-js`（特に Realtime）は Node API に依存 → **Edge では不可**。
- 対応:
  - **supabase-js を直接/間接に import するファイルの先頭に** `export const runtime = 'nodejs'` を付与。
  - API Route / Server Component / Server Action など **サーバ側**で利用すること。
  - Edge を使いたい場合は `@supabase/ssr` 等の Edge 対応 API に切り替え（Realtime 不可）。

### 9.2 ビルド時に発生した env 未定義エラーの対処

- 現象: `Missing NEXT_PUBLIC_SUPABASE_URL / KEY` などが **next build** 中に発生。
- 原因: `NEXT_PUBLIC_*` は **ビルド時に静的注入**されるため、**prod-build ステージにも値を渡す必要**がある。
- 対応:
  - Dockerfile（`prod-build`）で `ARG` → `ENV` を追加し、compose.prod の `build.args` から注入。
  - サーバ専用（機密）値は **ランタイム注入**を維持（compose の `environment:`）。
- 参考スニペット（再掲・要約）:
  ```dockerfile
  # Dockerfile (prod-build)
  ARG NEXT_PUBLIC_SUPABASE_URL
  ARG NEXT_PUBLIC_SUPABASE_KEY
  ENV NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
  ENV NEXT_PUBLIC_SUPABASE_KEY=${NEXT_PUBLIC_SUPABASE_KEY}
  ```
  ```yaml
  # docker-compose.prod.yml
  services:
    web:
      build:
        context: .
        target: prod-runtime
        args:
          NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
          NEXT_PUBLIC_SUPABASE_KEY: ${NEXT_PUBLIC_SUPABASE_KEY}
      environment:
        NODE_ENV: production
        PORT: 3000
        SUPABASE_URL: ${SUPABASE_URL}
        SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
  ```

### 9.3 supabaseServer.ts を遅延評価に変更

- 目的: **ビルド中のモジュール評価で env 検証が走って落ちる**問題を回避。
- 変更点:
  - トップレベルの env 読み/throw を削除し、**関数呼び出し時にチェック**。
  - シングルトン化（同一プロセスでの再利用）。
  - 利用側（API/Server）は **必ず** `export const runtime = 'nodejs'` を宣言。
- 主要関数: `getSupabaseServiceClient()`。

### 9.4 supabaseBrowser を TypeScript 化 & 型修正

- 目的: クライアント用 anon クライアントを **遅延評価/ブラウザ専用ガード/シングルトン**で安全化。
- 型エラー対応:
  - `SupabaseClient<DB, "public">` へ **第 2 型引数を "public" リテラルで固定**。
  - 実行時オプション `db: { schema: "public" }` を明示。
  - 返り値のジェネリクスで `Database` を指定可能。
- 主要関数: `getSupabaseBrowser<Database>()`。

### 9.5 data-service を server/client で分離

- 目的: API Route で **ブラウザ用クライアントを使ってしまう設計混在**の解消。
- 対応:
  - `app/_lib/data-service.server.ts`（サーバ用 = service ロール）と
    `app/_lib/data-service.client.ts`（クライアント用 = anon）へ分割。
  - API Route（`app/api/**/route.*`）は **server 版**を import。
- Quick Fix（当面）: 既存 data-service 内の `getSupabaseBrowser` 呼び出しを **`getSupabaseServiceClient()` に置換**。

### 9.6 Server Actions のディレクティブ修正

- 現象: `The "use server" directive must be at the top of the file`。
- 対応: `"use server"` を **ファイルの最初の行**に配置（括弧や余計な記述禁止）。
  代替として **各アクション関数の先頭**で `"use server"` も可。

### 9.7 SWC アーキ不一致と初期化レースの再発防止

- SWC: アーキを跨いだ後は `web-node-modules` を削除 → `build --no-cache` で正しい @next/swc を取得。
- 初回レース: `start-dev.sh` で **/app が空なら最大 60 秒待機** ＋ `node_modules` ウォームアップ。
- 権限: `useradd --create-home` ＆ `ENV HOME=/home/nodeapp` で SWC の DL 先を安定化。

### 9.8 追加コマンド（再掲・便利）

```bash
# prod ビルド失敗時のフルログ採取
docker compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache 2>&1 | tee build.log

# 実行時ログ確認
docker compose -f docker-compose.yml -f docker-compose.prod.yml logs -f --no-color web | sed -n '1,200p'

# アーキ確認
docker compose -f docker-compose.yml -f docker-compose.prod.yml exec web node -p "process.arch, process.version"
```

### 9.9 types/supabase.ts の整備

- 推奨: `supabase gen types typescript --project-id <REF> --schema public > types/supabase.ts`
- 暫定: 手書きミニマム版を配置後、マイグレーション毎に再生成。
- これにより `SupabaseClient<Database, "public">` の型安全が担保され、`Schema=string` 系の型エラーを防止。

---

## 10. 2025-10-19 追加対応ログ

### 10.1 パスエイリアス解決エラーの修正

- `jsconfig.json` と `tsconfig.json` に `baseUrl: "."` と `@/*` のパスを明示追加し、Next 14 が `@/app/_components/**` を正しく解決できるように調整。
- `Header.js` → `Navigation.js` の import 失敗が解消され、HMR/本番ビルドいずれでも alias が有効に。

### 10.2 Node.js / TypeScript バージョン整備

- `package.json` の `engines.node` を `>=18.17.0 <21` へ更新し、Next.js 14 系が要求する最小バージョンに合わせた。
- `devDependencies` に `typescript@~5.5.4` を追加して、Next 14 がサポートするコンパイラに固定。`package-lock.json` 再生成時に 5.5.x へ揃える想定。
- ルートに `.nvmrc (20.19.0)` を追加。`nvm` / `fnm` / `asdf` 等でワンコマンド切り替え可能。
- 備考: 現在のローカルは Node 18.16.0 のまま → `npm` が警告を出し、`npm install` が失敗する。`nvm install && nvm use` で 20.19.0 へ切り替え後、`npm install` を実施予定。

### 10.3 Server Actions / Supabase 周辺の調整

- `app/_lib/actions.js`
  - 冒頭の `export const runtime = "nodejs"` を撤去（"use server" ファイルではトップレベル export 禁止のため）。
  - 各アクションで `getSupabaseServiceClient()` を都度呼び出し、戻り値をローカル変数に保持する形へ修正。
  - `formData.get("observations")` の null ガードを追加し、`slice()` 呼び出し時の例外を防止。
- `app/_lib/data-service.server.ts`
  - `getGuest` / `createGuest`（Supabase service-role 用ヘルパー）を新規実装し、`auth.js` やプロフィール画面からの呼び出しをサポート。

### 10.4 国情報フェッチのフォールバック導入

- RestCountries API へのアクセスが制限される環境で `Bad Request`（実際は DNS 解決不可）となったため、API 失敗時にローカルで国リストを生成する仕組みを追加。
- 手順:
  1. `https://restcountries.com/v3.1/all?fields=name,flags,cca2` を優先的にフェッチ（成功時は従来どおりレスポンスを正規化）。
  2. 失敗した場合は `Intl.DisplayNames` とハードコードした ISO 3166-1 alpha-2 リストから国名/旗を生成し、メモ化した結果を返す。
  3. 国コードから emoji 旗を組み立てる `deriveFlagFromIso()` を追加。
- これにより `/account/profile` の `SelectCountry` がオフライン環境でも動作。

### 10.5 今後のフォローアップ

- Node 20.19.0 へ切り替えた上で `npm install` を再実行し、`package-lock.json` を最新状態に更新する。
- `npm run dev` / `npm run lint` を Node 20 系で再確認（RestCountries が解放された環境ではキャッシュタグ `countries` が再利用される）。
