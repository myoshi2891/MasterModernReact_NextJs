# 2025 年 10 月 18 日の変更内容まとめ

## はじめに

本ドキュメントでは、2025 年 10 月 18 日に実施した変更内容をまとめています。変更は大きく以下の 5 つのカテゴリに分類されます：

1. Supabase クライアントの再編成と認証機能の改善
2. 予約システムの機能強化と UX 向上
3. UI パフォーマンスの最適化
4. Docker 開発環境の整備
5. ドキュメントと設定の改善

各カテゴリの詳細な変更内容については、以下のセクションで説明します。

## セキュリティ対策の実施

### 現状の課題

以下の問題点が確認されました：

- `next.config.mjs` の remotePatterns で `lh3.googleusercontent.com` に対するパス制限が未設定
- 潜在的なセキュリティリスクが存在

### 対策内容

以下のように `next.config.mjs` の設定を変更しました：

```javascript
// 変更前
{
  protocol: "https",
  hostname: "lh3.googleusercontent.com"
}

// 変更後
{
  protocol: "https",
  hostname: "lh3.googleusercontent.com",
  pathname: "/a/**"
}
```

### 影響を受けるコンポーネント

次のコンポーネントが影響を受けます：

- `ReservationForm.js` のプロフィール画像表示
- `NavigationMenu.js` のプロフィール画像表示

### セキュリティ対策の効果

実装された対策により、次の効果が得られました：

- Google プロフィール画像の取得を `/a/` パス配下に制限
- 不要なリソースへのアクセスを防止
- 既存の `referrerPolicy="no-referrer"` 設定と組み合わせて、よりセキュアな実装を実現

## 予約システムの改善

### 発生していた問題

以下のエラーが発生していました：

- `Unhandled Runtime Error: Booking could not get loaded` エラーの発生
- 予約編集ページでのデータ取得の不具合

### 原因の特定と分析

1. クライアント/サーバークライアントの不適切な使用

   - `getBooking` 関数で `getSupabaseServiceClient()` を使用
   - `getBookings` 関数で `getSupabaseServiceClient` を使用

2. 必要なリレーションデータの欠落
   - cabins テーブルの関連データが未取得

### 実施した修正

以下の改善を実施しました：

1. `data-service.js` の `getBooking` 関数の改善：

```javascript
export async function getBooking(id) {
  const { data, error } = await getSupabaseServiceClient
    .from("bookings")
    .select("*, cabins(name, maxCapacity, image)")
    .eq("id", id)
    .single();

  if (error) {
    console.error(error);
    throw new Error("Booking could not get loaded");
  }

  if (!data) {
    throw new Error("Booking not found");
  }

  return data;
}
```

2. 予約編集ページ (`[bookingId]/page.js`) の最適化：

```javascript
const { bookingId } = params;
const booking = await getBooking(bookingId);
const {
  numGuests,
  observations,
  cabins: { maxCapacity },
} = booking;
```

### 改善による効果

本修正により、以下の効果が得られました：

- サーバーサイドでの一貫したデータ取得
- 単一クエリによるパフォーマンス向上
- より明確なエラーハンドリング
- コードの可読性と保守性の向上

## データベース初期化の改善

### 初期化スクリプトの問題点

以下の問題点が特定されました：

- `docker/initdb/01_create_supabase_admin.sh` でのロール作成/更新操作が暗黙的
- 操作結果の可視性が低い

### スクリプトの改善内容

1. PL/pgSQL ブロックに RAISE NOTICE メッセージを追加しました：

```sql
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'supabase_admin') THEN
    EXECUTE format(
      'CREATE ROLE supabase_admin LOGIN SUPERUSER PASSWORD %L',
      :'admin_password'
    );
    RAISE NOTICE 'Created role supabase_admin with superuser privileges';
    RETURN;
  END IF;

  EXECUTE format(
    'ALTER ROLE supabase_admin WITH PASSWORD %L',
    :'admin_password'
  );
  RAISE NOTICE 'Updated password for existing supabase_admin role';
END
$$;
```

2. シェルスクリプトに完了メッセージを追加しました：

```bash
echo "[supabase-admin] Database role setup completed successfully" >&2
```

### 改善後の運用効果

データベース初期化の改善により、以下の効果が得られました：

- データベースロール操作の透明性向上
- コンテナ起動時の操作結果の明確化
- トラブルシューティングの容易化

## 詳細な変更履歴

### 1. Supabase クライアント再編と認証周り

- `app/_lib/getSupabaseServiceClient.js` を新設し、サービスロールキーを使うサーバー専用クライアントを生成
  - 環境変数の存在チェックを追加
  - ブラウザからの誤 import を防ぐガードを実装
- `app/_lib/getSupabaseServiceClient().js` を追加
  - `NEXT_PUBLIC` 系のキーでブラウザ用クライアントを作成
  - セッション永続化を許可する設定を追加
- 認証関連のコード整理
  - 旧 `app/_lib/supabase.js` と `app/_lib/supabase-admin.js` を削除
  - `app/_lib/actions.js` と `app/_lib/data-service.js` で新クライアントを使用
  - 予約 CRUD の再検証対象に `/account/reservations` を追加

### 2. 予約システムの UX 改善

- `app/account/reservations/page.js` の強化
  - `dynamic = "force-dynamic"` 設定を追加
  - セッション検証を厳格化
  - 空予約時の導線を改善（`Link` コンポーネントの採用）
- 予約編集機能の改善
  - `getBooking` でキャビン情報を join する実装に変更
  - 存在しない予約の明示的なエラーハンドリングを追加
  - 最大収容人数を 1 クエリで取得するよう最適化
- `ReservationCard.js` のレイアウト最適化
  - 画像のレスポンス最適化（`sizes`・`fill` 指定）
  - モバイル表示の改善
  - 価格・予約日情報の表示調整

### 3. UI とパフォーマンスの改善

- フォント配信の最適化
  - Google Fonts の配信を停止
  - `app/fonts/` に可変フォントを同梱
  - `next/font/local` による読み込みに変更
- 画像読み込みの最適化
  - `sizes`・`fetchPriority`・`loading` 属性の追加
  - ヒーロー画像とロゴの読み込み UX を改善
- モバイル UI の改善
  - ナビゲーションメニューの幅調整
  - タップ領域の最適化
  - 視認性の向上

### 4. 開発環境の整備

- Docker 設定の改善
  - Next.js 用の`Dockerfile`を新規作成
  - `.next`キャッシュ用のボリューム追加
  - `npm ci`によるビルド時のインストール
  - ヘルスチェックを `docker/postgres-healthcheck.sh` へ置き換えて `psql` ベースで検証
- PostgreSQL 初期化の自動化
  - ロール作成スクリプトの追加
  - タイムゾーン設定の自動化
  - マイグレーション適用の順序制御
  - 初期化スクリプトのマウント漏れを解消（01/05 スクリプトを追加）
- 環境変数の整理
  - Supabase 関連の環境変数を整理
  - データベース設定の明示化
- 開発効率の向上
  - `.dockerignore`の拡充
  - Docker 関連のエイリアス追加
  - 起動スクリプトの改善
  - `stop_grace_period` を延長して Postgres 停止時のクラッシュリカバリーを防止

### 5. ドキュメントと設定の改善

- ドキュメントの整備
  - `README_supabase.md`の見出しレベル統一
  - コードブロックの言語指定追加
  - アクセス URL の表記統一
- 開発環境の調整
  - `.gitignore`の更新（`.idea`と Playwright 関連）
  - `eslint`バージョンの固定（`^8.57.0`）
- セキュリティ設定
  - Google OAuth アバター表示の許可設定追加
  - リモートパターンの適切な設定

## 継続的な改善項目

今後、以下の課題に取り組む必要があります：

1. セキュリティ強化

   - 他の外部リソースのパス制限の見直し
   - 認証関連のエラーハンドリングの強化

1. パフォーマンス最適化

   - データ取得クエリの更なる最適化
   - クライアント/サーバーコンポーネントの適切な使い分けの見直し

1. 運用改善
   - ログ出力の標準化
   - エラーメッセージの多言語対応

## 追加の改善内容

### 1. 予約編集ページのエラーハンドリング強化

`app/account/reservations/edit/[bookingId]/page.js` のデータ取得処理を改善：

- try/catch によるエラーハンドリングの追加
- booking オブジェクトの存在確認の実装
- オプショナルチェイニングによる null セーフなアクセス
- 適切なデフォルト値の設定

```javascript
const numGuests = booking?.numGuests ?? 1;
const observations = booking?.observations ?? "";
const maxCapacity = booking?.cabins?.maxCapacity ?? 4;
```

### 2. 開発環境スクリプトの堅牢性向上

`docker/start-dev.sh` の実行時の安全性を改善：

- gosu コマンドの存在チェックを追加
- 未インストール時の明確な警告メッセージ
- 代替実行パスの実装

```bash
if check_gosu; then
  exec gosu nodeapp "$@"
else
  echo "Attempting to continue without gosu..." >&2
  exec "$@"
fi
```

### 3. レスポンシブデザインの強化

`app/page.js` のヒーローセクションを改善：

- メインヘッドラインのフォントサイズをレスポンシブ対応に変更
- 画面サイズに応じた段階的なサイズ調整

```javascript
className =
  "text-4xl sm:text-6xl md:text-8xl text-primary-50 mb-10 tracking-tight font-normal";
```

- サイズ別の対応：
  - モバイル: 36px (text-4xl)
  - タブレット: 60px (sm:text-6xl)
  - デスクトップ: 96px (md:text-8xl)

## 変更のまとめ

本日の変更により、以下の点でアプリケーションが改善されました：

- 外部リソースアクセスの制限によるセキュリティ強化
- データ取得ロジックの改善によるエラー低減
- 運用可視性の向上
- エラーハンドリングの強化
- モバイル対応の改善
- 開発環境の堅牢性向上

これらの改善により、アプリケーションの品質が全体的に向上し、より安定した運用が可能になりました。
