name: ci

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: [20.x, 22.x]
    env:
      NEXT_PUBLIC_SUPABASE_URL: http://localhost:54321
      NEXT_PUBLIC_SUPABASE_KEY: test
      SUPABASE_URL: http://localhost:54321
      SUPABASE_SERVICE_ROLE_KEY: test
      AUTH_GOOGLE_ID: test
      AUTH_GOOGLE_SECRET: test
      NEXTAUTH_URL: http://localhost:3000
      NEXTAUTH_SECRET: test-secret
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint
      - name: Unit tests
        run: npm run test:unit
      - name: Component tests
        run: npm run test:component
      - name: Build
        env:
          SKIP_SSG: "true"
        run: npm run build
      - name: Smoke test
        run: |
          npm run start -- --hostname 127.0.0.1 --port 3000 > server.log 2>&1 &
          server_pid=$!
          echo "Server PID: $server_pid"
          sleep 3
          for i in {1..20}; do
            if curl -fsS --max-time 5 --connect-timeout 2 http://127.0.0.1:3000/api/health > /dev/null 2>&1; then
              echo "Health check ok"
              kill $server_pid
              wait $server_pid || true
              exit 0
            fi
            echo "Attempt $i/20 failed, retrying..."
            sleep 1
          done
          echo "Health check failed"
          echo "=== Server logs ==="
          cat server.log
          kill $server_pid
          wait $server_pid || true
          exit 1

  e2e:
    runs-on: ubuntu-latest
    needs: lint-and-test
    env:
      NEXT_PUBLIC_SUPABASE_URL: http://localhost:54321
      NEXT_PUBLIC_SUPABASE_KEY: test
      SUPABASE_URL: http://localhost:54321
      SUPABASE_SERVICE_ROLE_KEY: test
      AUTH_GOOGLE_ID: test
      AUTH_GOOGLE_SECRET: test
      NEXTAUTH_URL: http://localhost:3000
      NEXTAUTH_SECRET: test-secret
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      - name: Build
        env:
          SKIP_SSG: "true"
        run: npm run build
      - name: Run E2E tests
        run: npm run test:e2e
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
