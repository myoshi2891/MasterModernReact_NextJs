name: ci

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

# Common environment variables for all jobs
env:
  NEXT_PUBLIC_SUPABASE_URL: http://localhost:54321
  NEXT_PUBLIC_SUPABASE_KEY: test
  SUPABASE_URL: http://localhost:54321
  SUPABASE_SERVICE_ROLE_KEY: test
  AUTH_GOOGLE_ID: test
  AUTH_GOOGLE_SECRET: test
  NEXTAUTH_URL: http://localhost:3000
  NEXTAUTH_SECRET: test-secret
  HASH_SALT: ci-test-salt-not-for-production-use

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: [20.19.6, 22.x]
    env:
      # Skip Playwright browser download for non-E2E jobs
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3"
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Lint
        run: bun run lint
      - name: Type check
        run: bun run typecheck
      - name: Unit tests
        run: bun run test:unit
      - name: Component tests
        run: bun run test:component
      - name: Build
        env:
          SKIP_SSG: "true"
        run: bun run build
      - name: Smoke test
        run: |
          bun run start -- --hostname localhost --port 3000 > server.log 2>&1 &
          server_pid=$!
          echo "Server PID: $server_pid"
          sleep 3
          for i in {1..20}; do
            if curl -fsS --max-time 5 --connect-timeout 2 http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "Health check ok"
              kill $server_pid
              wait $server_pid || true
              exit 0
            fi
            echo "Attempt $i/20 failed, retrying..."
            sleep 1
          done
          echo "Health check failed"
          echo "=== Server logs ==="
          cat server.log
          kill $server_pid
          wait $server_pid || true
          exit 1

  e2e:
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3"
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.6
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Install Playwright browsers
        run: bunx playwright install --with-deps chromium
      - name: Build
        env:
          SKIP_SSG: "true"
        run: bun run build
      - name: Run E2E tests
        run: bun run test:e2e
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
