# Tasks: 予約の同時実行対策（重複予約防止とDB整合性）

## タスク分解
- [x] `startDate`/`endDate` の型確認（2025-12-25完了: timestamp型）
- [x] `status` の実値確認と「キャンセル値」の確定（2025-12-25完了: canceled）
- [x] 既存データの重複/不整合チェック（2025-12-25完了）
- [x] 重複・逆転データのクリーンアップ（2025-12-25完了: 3件削除）
- [x] DB Migration 作成（排他制約 + チェック制約）（2025-12-25完了）
- [x] migration 適用（Supabase SQL Editorで実行）（2025-12-25完了）
- [x] トリガー例外の SQLSTATE を決定（P0001 + メッセージ）（保留: トリガーなしで運用）
- [x] `createBooking` のエラーコード変換（23P01/23514/23505/P0001）（2025-12-28完了）
- [ ] idempotency key の導入可否を決定（将来検討）
- [ ] ローカル Supabase で並列予約テストを実施
- [ ] パフォーマンス影響の計測（ステージング環境での検証が必要）
- [x] 監視・ログの文言を定義（PII なし）（2025-12-28完了: errors.jsで実装）
- [ ] 409 連発時の運用判断基準（混雑/システム異常）を整理

## 依存関係
- Supabase ローカル環境 or ステージング環境
- `bookings` / `cabins` テーブルスキーマの確定

## 見積
- 設計 1 日
- 実装 1.5 日
- 検証・移行 1〜1.5 日
- 合計 3〜4 日

## テスト観点（実装時）
- [ ] 同一キャビン/同日程の並列予約で片方が 409
- [ ] `status = canceled` の予約がある場合、重複が許容される
- [ ] `startDate >= endDate` で 400
- [ ] `numGuests = 0` で 400
- [ ] `numGuests > maxCapacity` で拒否される
- [ ] idempotency key の重複で 409
- [ ] CAPACITY_EXCEEDED の P0001 が 400 に変換される

## 完了定義
- DB 制約により重複予約が必ず拒否される
- 競合時に 409 が返る
- 既存テストが全て通る
- ロールバック手順がドキュメント化されている
