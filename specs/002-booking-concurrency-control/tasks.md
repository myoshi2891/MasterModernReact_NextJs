# Tasks: 予約の同時実行対策（重複予約防止とDB整合性）

## タスク分解
- [x] `startDate`/`endDate` の型確認（2025-12-25完了: timestamp型）
- [x] `status` の実値確認と「キャンセル値」の確定（2025-12-25完了: canceled）
- [x] 既存データの重複/不整合チェック（2025-12-25完了）
- [x] 重複・逆転データのクリーンアップ（2025-12-25完了: 3件削除）
- [x] DB Migration 作成（排他制約 + チェック制約）（2025-12-25完了）
- [x] migration 適用（Supabase SQL Editorで実行）（2025-12-25完了）
- [x] トリガー例外の SQLSTATE を決定（P0001 + メッセージ）（保留: トリガーなしで運用）
- [x] `createBooking` のエラーコード変換（23P01/23514/23505/P0001）（2025-12-28完了）
- [ ] idempotency key の導入可否を決定（将来検討）
- [x] ローカル環境で並列予約テストを実施（2026-01-01完了: Docker Postgres 17）
- [x] パフォーマンス影響の計測（2026-01-01完了: Docker Postgres 17でベンチマーク実施）
- [x] 監視・ログの文言を定義（PII なし）（2025-12-28完了: errors.jsで実装）
- [x] 409 連発時の運用判断基準（混雑/システム異常）を整理（2026-01-01完了: operations.md作成）

## 依存関係
- Supabase ローカル環境 or ステージング環境
- `bookings` / `cabins` テーブルスキーマの確定

## 見積
- 設計 1 日
- 実装 1.5 日
- 検証・移行 1〜1.5 日
- 合計 3〜4 日

## テスト観点（実装時）

### 重複検出（EXCLUDE制約）
- [x] 同一キャビン/同日程の並列予約で片方が拒否される（2026-01-01検証: 23P01エラー）
- [x] 部分的に重なる期間で拒否される（2026-01-01検証: 23P01エラー）
- [x] チェックアウト日=次のチェックイン日は許容される（2026-01-01検証: `[)` 範囲設定による意図的な境界条件）
- [x] `status = canceled` の予約がある場合、重複が許容される（2026-01-01検証）

### 入力バリデーション（CHECK制約）
- [x] `startDate >= endDate` で拒否される（2026-01-01検証: 23514エラー）
- [x] `numGuests = 0` で拒否される（2026-01-01検証: 23514エラー）

### 未実装（将来対応）
- [ ] `numGuests > maxCapacity` で拒否される（トリガー未実装のため未検証）
- [ ] idempotency key の重複で 409（未実装のため未検証）
- [ ] CAPACITY_EXCEEDED の P0001 が 400 に変換される（トリガー未実装のため未検証）

### ローカル並列予約テスト結果（2026-01-01）

| # | テスト内容 | テスト観点 | 期待結果 | 実際の結果 | SQLSTATE |
|---|-----------|-----------|---------|-----------|----------|
| 1 | 同一期間の重複予約 | EXCLUDE制約 | 拒否 | 拒否 | 23P01 |
| 2 | 部分的に重なる期間 | EXCLUDE制約 | 拒否 | 拒否 | 23P01 |
| 3 | チェックアウト日=チェックイン日 | 境界条件 `[)` | 許容 | 許容 | - |
| 4 | キャンセル済みとの重複 | WHERE句除外 | 許容 | 許容 | - |
| 5 | startDate >= endDate | CHECK制約 | 拒否 | 拒否 | 23514 |
| 6 | numGuests = 0 | CHECK制約 | 拒否 | 拒否 | 23514 |
| 7 | 並列INSERT（競合） | EXCLUDE制約 | 片方拒否 | 片方拒否 | 23P01 |

**テスト環境**: Docker postgres:17, btree_gist拡張有効

### パフォーマンス計測結果（2026-01-01）

**テスト環境**: Docker postgres:17, Apple Silicon (arm64)

#### 単一INSERTの比較

| 条件 | 平均時間 | 備考 |
|------|---------|------|
| 制約なし（ベースライン） | 0.026 ms | FK制約のみ |
| EXCLUDE制約あり（空テーブル） | 0.029 ms | +12% |
| EXCLUDE制約あり（10k件） | 0.061 ms | +135% |
| EXCLUDE制約あり（50k件） | 0.068 ms | +162% |

#### バルクINSERTの比較

| データ量 | 所要時間 | 1件あたり | GiSTインデックスサイズ |
|---------|---------|----------|---------------------|
| 1,000件 | 20 ms | 0.020 ms | - |
| 10,000件 | 266 ms | 0.027 ms | 832 KB |
| 50,000件 | 1,536 ms | 0.031 ms | 3,864 KB |

#### 結論

- **オーバーヘッド**: 単一INSERTで約0.03〜0.04ms増（実用上問題なし）
- **スケーラビリティ**: 50k件でも1件あたり0.07ms未満
- **インデックスサイズ**: テーブルサイズと同程度（50k件で約4MB）
- **推奨**: 本番環境でも許容可能なパフォーマンス

## 完了定義
- DB 制約により重複予約が必ず拒否される
- 競合時に 409 が返る
- 既存テストが全て通る
- ロールバック手順がドキュメント化されている
