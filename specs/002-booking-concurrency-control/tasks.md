# Tasks: 予約の同時実行対策（重複予約防止とDB整合性）

## タスク分解
- [ ] 既存データの重複/不整合チェック（SQL で事前確認）
- [ ] 重複・逆転データのクリーンアップ方針を決定
- [ ] DB Migration 作成（排他制約 + チェック制約 + トリガー）
- [ ] migration 適用順序とロールバック手順の確定
- [ ] `createBooking` のエラーコード変換（23P01/23514/23505）
- [ ] idempotency key の導入可否を決定（導入する場合は UI/Server 連携）
- [ ] ローカル Supabase で並列予約テストを実施
- [ ] 監視・ログの文言を定義（PII なし）
- [ ] 409 連発時の運用判断基準（混雑/システム異常）を整理

## 依存関係
- Supabase ローカル環境 or ステージング環境
- `bookings` / `cabins` テーブルスキーマの確定

## 見積
- 設計 0.5 日
- 実装 1 日
- 検証 0.5 日

## テスト観点（実装時）
- [ ] 同一キャビン/同日程の並列予約で片方が 409
- [ ] `status = canceled` の予約がある場合、重複が許容される
- [ ] `startDate >= endDate` で 400
- [ ] `numGuests = 0` で 400
- [ ] `numGuests > maxCapacity` で拒否される
- [ ] idempotency key の重複で 409

## 完了定義
- DB 制約により重複予約が必ず拒否される
- 競合時に 409 が返る
- 既存テストが全て通る
- ロールバック手順がドキュメント化されている
