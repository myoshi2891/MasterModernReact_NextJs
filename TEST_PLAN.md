# テスト計画書: The Wild Oasis (Next.js 14)

## 目次
- [0. ドキュメント情報](#0-ドキュメント情報)
- [1. 目的](#1-目的)
- [2. テスト対象](#2-テスト対象)
- [3. テスト対象外](#3-テスト対象外)
- [4. 前提・制約](#4-前提制約)
- [5. リスクと重点](#5-リスクと重点)
- [6. テスト戦略](#6-テスト戦略)
- [7. テスト環境](#7-テスト環境)
- [8. テストデータ](#8-テストデータ)
- [9. テスト観点チェックリスト](#9-テスト観点チェックリスト)
- [10. エントリ条件](#10-エントリ条件)
- [11. 終了条件](#11-終了条件)
- [12. 成果物](#12-成果物)
- [13. 自動化方針](#13-自動化方針)
- [14. 回帰テスト方針](#14-回帰テスト方針)

## 0. ドキュメント情報
| 項目 | 内容 |
| --- | --- |
| 対象 | The Wild Oasis (Next.js 14 App Router) |
| 作成日 | 2025-12-21 |
| 対象機能 | キャビン閲覧・予約・アカウント管理・認証・API |
| 主な外部依存 | Supabase, Google OAuth, restcountries |
| 目的 | 重大不具合の早期検出、回帰防止、品質ゲートの明確化 |

## 1. 目的
- 予約フローの信頼性と安全性を担保する
- 認証・認可の抜け漏れを厳格に検出する
- Supabase を前提としたデータ整合性・権限の不備を炙り出す
- UI/UX、パフォーマンス、アクセシビリティの品質基準を満たす

## 2. テスト対象
- 主要ページとルート
- 予約作成・編集・削除のサーバーアクション
- Supabase とのデータアクセスと RLS 前提
- NextAuth v4 認証フロー
- API ルート `/api/cabins/[cabinId]`

## 3. テスト対象外
- Supabase 管理コンソールの運用機能
- Google OAuth プロバイダの外部挙動そのもの
- 画像 CDN の障害耐性や SLA
- 開発者用ドキュメントの内容品質

## 4. 前提・制約
- Node.js `>=20` を前提とし、CI では 20/22 を検証する
- 環境変数が未設定の場合は起動エラーになる
- Supabase はローカル or ステージング環境を使用する
- E2E は Playwright、ユニット/コンポーネントは Vitest を想定

## 5. リスクと重点
- 認可漏れによる他ユーザー予約の閲覧・編集・削除
- 予約日重複や同時実行による二重予約
- サーバーアクションの入力改ざんによる不正データ
- 外部 API 失敗時のエラーハンドリング不足
- 画像ホスティング制限による UI 崩れ

## 6. テスト戦略
| レベル | 目的 | 主ツール |
| --- | --- | --- |
| ユニット | バリデーション・ユーティリティ・純粋関数 | Vitest |
| コンポーネント | UI 状態遷移・フォーム検証 | Testing Library |
| 統合 | サーバーアクション + Supabase の整合性 | Vitest + MSW |
| E2E | 予約フロー・認証フロー | Playwright |

## 7. テスト環境
- ブラウザ: Chrome, Firefox, Safari (最新 2 メジャー)
- デバイス: デスクトップ, iPhone 相当, Android 相当
- OS: macOS, Windows
- ネットワーク: 通常 / 低速 / 切断復帰
- タイムゾーン: UTC, JST, PST

## 8. テストデータ
- `cabins`: 複数件、最大宿泊人数の境界 (3, 4, 7, 8, 12)
- `settings`: 最小/最大宿泊日数の境界値
- `guests`: 既存/未作成の両パターン
- `bookings`: 過去/未来/当日/重複を含む

## 9. テスト観点チェックリスト

### 9.1 認証・認可
- 未ログインで `/account` と配下ページへアクセス時の挙動
- ログイン後のリダイレクト先とセッション維持
- `guestId` が未設定または null の場合の動作
- 別ユーザー予約 ID の編集ページ閲覧可否
- 予約更新・削除の権限チェックがサーバー側で通るか
- ログアウト後のセッション破棄と戻る操作の無効化

### 9.2 キャビン一覧
- 取得失敗時のエラー表示と復帰導線
- 空配列時の UI 表示
- `capacity` フィルタの境界値と URL 共有
- 並び順 (name 昇順) の保証
- ISR キャッシュの更新タイミング

### 9.3 キャビン詳細
- 不正 ID の not-found 表示
- `generateMetadata` の成功/失敗挙動
- 画像の表示 (Next Image remotePatterns)
- 予約 UI の表示条件 (ログイン有無)

### 9.4 日付選択と価格計算
- 過去日付の選択不可
- 既予約日の選択不可と範囲選択時のキャンセル
- 最小/最大宿泊日数の境界値
- タイムゾーン/DST による日付ズレ
- 割引価格と合計金額の計算精度

### 9.5 予約作成
- 必須項目未入力時の防止
- `numGuests` が `maxCapacity` 超過の防止
- `numNights` が 0 または負数の防止
- 連続実行による二重登録の防止
- 成功時のリダイレクトと再検証
- 失敗時の UI エラーとリトライ

### 9.6 予約一覧・編集・削除
- 予約が 0 件時の案内表示
- 未来/過去のステータス表示切替
- 編集ページの初期値と最大人数の一致
- 他人の予約を更新できないこと
- 削除の確認ダイアログとキャンセル動作
- Optimistic 更新失敗時の UI 巻き戻し

### 9.7 プロフィール更新
- 国籍の選択/未選択の保存
- 国旗取得 API 失敗時のエラー表示
- `nationalID` の 6-12 文字制約
- 空値許容の確認
- Full name / Email の編集不可

### 9.8 API ルート
- `/api/cabins/[cabinId]` 正常応答
- 不正 ID 時の応答ボディとステータス
- 予約日配列の正確性

### 9.9 エラーハンドリング
- `app/error.js` の表示と復帰動線
- `app/not-found.js` の表示
- サーバーアクション例外時のユーザー導線

### 9.10 セキュリティ
- サーバー専用クライアントのクライアント露出防止
- RLS を前提としたデータアクセスの検証
- フォーム改ざんによる不正データ混入の検出
- PII のログ漏えい確認
- 画像ドメイン制限の動作

### 9.11 パフォーマンス
- 初回表示の LCP と TTFB
- Supabase 呼び出しの過剰回数
- 予約一覧の動的ページロード時間

### 9.12 アクセシビリティ
- 主要フォームのラベル紐付け
- キーボード操作のみで予約完結
- フォーカス可視性とコントラスト

### 9.13 レスポンシブ
- 予約日付 UI の 1 か月/2 か月表示切替
- 主要ページのレイアウト崩れ
- 固定 UI (リマインダー) の被り

## 10. エントリ条件
- 主要機能が実装済みである
- 基本的な環境変数が設定済み
- テスト用 Supabase に必要なデータが投入済み

## 11. 終了条件
- 重大度 High 以上の不具合が 0 件
- 回帰対象の E2E が全て成功
- 主要ユースケースが QA で完了

## 12. 成果物
- 本テスト計画書
- テスト結果レポート
- 重大不具合の一覧と再現手順
- 自動テストコード一式

## 13. 自動化方針
- 予約フローと認証フローは E2E を最優先
- サーバーアクションは入力改ざんパスを含めて統合テスト
- 外部 API 依存は MSW でモック

## 14. 回帰テスト方針
- 認証・予約・編集・削除の全経路を必須回帰対象とする
- Supabase スキーマ変更時は予約・ゲスト関連の全テストを再実行
