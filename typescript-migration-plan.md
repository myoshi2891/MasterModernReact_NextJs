---
name: typescript-migration-plan
description: Next.js App Router TS migration plan (phased)
updated: 2025-12-30
---

# Plan

## Summary

Migrate the existing Next.js 14 App Router codebase from JavaScript to TypeScript without changing runtime behavior. Enable strict type checking from the start, introduce shared domain types and generated Supabase types, then convert files from the data layer outward to UI. Finish by disabling allowJs and validating build/lint/typecheck.

## Requirements

- Preserve current behavior and routing; type additions only
- Enable strict type checking from day one
- Generate Supabase types via `supabase gen types`
- Keep allowJs enabled during the migration, then disable it after completion
- Ensure `next build`, `next lint`, and `tsc --noEmit` succeed
- All existing tests must pass after migration
- **Minimum TypeScript version: ^5.3** (for Next.js 14 compatibility)

## Scope

### In Scope

- `app/**/*.js`, `app/**/*.jsx` (56 files)
- `app/_lib/**/*.js` (8 files: actions, auth, booking, data-service, errors, guest, supabaseBrowser, supabaseServer)
- `app/_components/**/*.jsx` (27 files)
- `app/api/**/route.js` (3 files)
- `middleware.js`
- `package.json`, `jsconfig.json` → `tsconfig.json`
- `tests/unit/**/*.test.js` (6 files)
- `tests/component/**/*.test.jsx` (10 files)

### Out of Scope

- DB/schema changes, auth provider changes, UI/UX redesign, new features
- Config files: `next.config.mjs`, `postcss.config.mjs`, `tailwind.config.js` (keep as JS)

### Already TypeScript (No Action Needed)

- `vitest.config.mts` ✓
- `playwright.config.ts` ✓
- `tests/setup.ts` ✓
- `tests/msw/handlers.ts` ✓
- `tests/msw/server.ts` ✓
- `next-env.d.ts` ✓ (auto-generated by Next.js)

## Files and Entry Points

### New Files to Create

- `tsconfig.json` (from jsconfig.json, with strict options)
- `types/domain.ts` (Cabin, Booking, Guest, Settings, Country)
- `types/supabase.ts` (generated via supabase gen types)
- `types/next-auth.d.ts` (module augmentation for session.user.guestId)
- `types/env.d.ts` (environment variable types)
- `types/server-actions.ts` (typed Server Action helpers)

### Files to Migrate

| Layer | Files | Priority |
|-------|-------|----------|
| Data/Auth | `app/_lib/*.js` (8 files) | Phase 2 |
| API Routes | `app/api/**/route.js` (3 files) | Phase 3 |
| Middleware | `middleware.js` | Phase 3 |
| Components | `app/_components/*.jsx` (27 files) | Phase 4 |
| Pages/Layouts | `app/**/page.jsx`, `layout.jsx`, etc. (18 files) | Phase 4 |
| Unit Tests | `tests/unit/*.test.js` (6 files) | Phase 6 |
| Component Tests | `tests/component/*.test.jsx` (10 files) | Phase 6 |

## Data Model / API Changes

- Generate Supabase Database types and use `createClient<Database>()`
- Add domain-level types for app-specific models and view models
- Add NextAuth module augmentation to extend `session.user.guestId` and `token.guestId`
- No runtime/API behavior changes; types only

## Dependencies

### To Install (Pinned Versions)

```bash
npm install -D typescript@~5.7.2 @types/node@^20.0.0 @types/react@^18.0.0 @types/react-dom@^18.0.0
```

**Version Policy:**
- `typescript@~5.7.2` - Use tilde for patch updates only, compatible with Next.js 14
- `@types/node@^20.0.0` - Match Node.js engine requirement (>=20)
- `@types/react@^18.0.0` - Match React version
- `@types/react-dom@^18.0.0` - Match React DOM version

**Why tilde (~) for TypeScript, caret (^) for @types?**
- **TypeScript (~):** Minor version upgrades (e.g., 5.7 → 5.8) can introduce stricter type checking or breaking changes. Using tilde limits updates to patch versions only (5.7.x), ensuring consistent behavior across team members and CI.
- **@types packages (^):** These are type-only and follow the library they type. Caret allows minor version updates (e.g., 18.0 → 18.3) which typically add new type definitions without breaking changes. Patch-only would miss useful type improvements.

**Note:** `package-lock.json` ensures reproducible builds. Run `npm ci` in CI environments.

### Already Typed (No @types needed)

- `@supabase/supabase-js` - TypeScript native
- `date-fns` v3 - TypeScript native
- `react-day-picker` - TypeScript native
- `@heroicons/react` - TypeScript native
- `next-auth` - TypeScript native
- `msw` - TypeScript native
- `vitest` - TypeScript native
- `@playwright/test` - TypeScript native
- `@testing-library/react` - TypeScript native

## Phase-by-Phase Action Items

### Phase 1: Foundation Setup ✅ (Completed: 2025-12-30)

- [x] Install TypeScript dependencies with pinned versions
  ```bash
  npm install -D typescript@~5.7.2 @types/node@^20.0.0 @types/react@^18.0.0 @types/react-dom@^18.0.0
  ```
- [x] Create `tsconfig.json` with strict settings
  ```json
  {
    "compilerOptions": {
      "target": "ES2022",
      "lib": ["dom", "dom.iterable", "esnext"],
      "allowJs": true,
      "checkJs": false,
      "skipLibCheck": true,  // Skip type checking of declaration files for faster builds
      "strict": true,
      "noEmit": true,
      "esModuleInterop": true,
      "module": "esnext",
      "moduleResolution": "bundler",
      "resolveJsonModule": true,
      "isolatedModules": true,
      "jsx": "preserve",
      "incremental": true,
      "plugins": [{ "name": "next" }],
      "baseUrl": ".",
      "paths": { "@/*": ["./*"] }
    },
    "include": [
      "next-env.d.ts",
      "types/**/*.ts",
      "app/**/*.ts",
      "app/**/*.tsx",
      "tests/**/*.ts",
      "tests/**/*.tsx",
      ".next/types/**/*.ts"
    ],
    "exclude": [
      "node_modules",
      ".next",
      "coverage",
      "playwright-report",
      "test-results"
    ]
  }
  ```
- [x] Add `typecheck` script to package.json
  ```json
  "typecheck": "tsc --noEmit"
  ```
- [x] Add typecheck to CI pipeline (`.github/workflows/ci.yml`)
  ```yaml
  - name: Type check
    run: npm run typecheck
  ```
- [x] Create `types/` directory structure
- [x] Generate Supabase types (manually created due to local Supabase not running)
  ```bash
  supabase gen types typescript --linked > types/supabase.ts
  ```
- [x] Create `types/domain.ts` with app-specific types
- [x] Create `types/next-auth.d.ts` for session augmentation
- [x] Create `types/env.d.ts` for environment variables
- [x] Create `types/server-actions.ts` with typed helpers (see reference below)
- [x] **Measure and record performance baselines:** ✅ 2025-12-31 計測完了
  ```bash
  # Record baseline for performance comparison
  time npm run typecheck  # 結果: 4.2秒 ✅ 目標<30秒をクリア
  time npm run build      # 結果: 47.6秒 ✅ ベースライン設定
  ```
- [x] **Document baselines and set up monitoring:** ✅ 2025-12-31 記録完了
  - [x] Record actual measured values in `docs/progress.md`
  - 監視基準: build時間が52.4秒（+10%）を超えた場合はアラート対象
    - 根拠: 開発サイクルへの影響を最小限に抑えるため、業界標準のベースライン±10%を閾値として採用
    - 対応: 閾値超過時は incremental ビルド設定、`skipLibCheck`、並列化オプションの見直しを検討
  - typecheck が25秒に近づいた場合は incremental 設定の見直しを検討
  - 計測環境: macOS (Darwin 24.6.0), Node.js 20.19.6

### Phase 2: Data/Auth Layer (.js → .ts) ✅ (Completed: 2025-12-31)

**Migration Order** (utilities first, then consumers):

1. [x] `app/_lib/errors.js` → `.ts` **(First - no dependencies)**
   - Type BookingError class and mapSupabaseError function
   - Added `BookingErrorCode` type and `SupabaseError` interface

2. [x] `app/_lib/guest.js` → `.ts` **(Second - utility)**
   - Type normalizeNationalId function with union type parameter

3. [x] `app/_lib/supabaseServer.js` → `.ts` **(Third - client setup)**
   - Note: Database generic causes overly strict type inference; using untyped client with app-layer type safety

4. [x] `app/_lib/supabaseBrowser.js` → `.ts`
   - Same approach as supabaseServer

5. [x] `app/_lib/booking.js` → `.ts`
   - Added `DateRange` and `BookingValidationInput` interfaces
   - Type validateBookingInput and related functions

6. [x] `app/_lib/data-service.js` → `.ts`
   - Type all data-fetching functions (getCabins, getBooking, etc.)
   - Added `BookingWithCabin`, `BookingListItem`, `NewGuestInput` interfaces

7. [x] `app/_lib/auth.js` → `.ts`
   - Type NextAuth config and callbacks with `NextAuthOptions`
   - Uses session augmentation types from `types/next-auth.d.ts`

8. [x] `app/_lib/actions.js` → `.ts` **(Last - depends on all above)**
   - Type Server Actions with FormData handling
   - Added `CreateBookingData` interface
   - All 77 unit tests + 22 component tests passing

### Phase 3: API Routes & Middleware ✅ (Completed: 2025-12-31)

- [x] `middleware.js` → `middleware.ts`
  - Type withAuth config with `NextAuthMiddlewareOptions`
- [x] `app/api/auth/[...nextauth]/route.js` → `.ts`
  - Type route handlers
- [x] `app/api/cabins/[cabinId]/route.js` → `.ts`
  - Type params and response with `NextResponse<Cabin>`
- [x] `app/api/health/route.js` → `.ts`
  - Type response with `NextResponse<{ status: string }>`

### Phase 4: Components & Pages (.jsx → .tsx) ✅ (Completed: 2025-12-31)

#### Components (27 files) ✅

- [x] Context: `ReservationContext.jsx` → `.tsx`
  - Define context type with DateRange
- [x] Forms: `UpdateProfileForm.jsx`, `ReservationForm.jsx` → `.tsx`
  - Type form props and Server Action bindings
- [x] Cards: `CabinCard.jsx`, `ReservationCard.jsx` → `.tsx`
- [x] Lists: `CabinList.jsx`, `ReservationList.jsx` → `.tsx`
- [x] Navigation: `Navigation.jsx`, `NavigationMenu.jsx`, `SideNavigation.jsx` → `.tsx`
- [x] Auth: `SignInButton.jsx`, `SignOutButton.jsx` → `.tsx`
- [x] UI: `Spinner.jsx`, `SpinnerMini.jsx`, `SubmitButton.jsx`, etc. → `.tsx`
- [x] Other: `Cabin.jsx`, `DateSelector.jsx`, `Filter.jsx`, `Header.jsx`, `Logo.jsx`, etc. → `.tsx`

#### Pages & Layouts (18 files) ✅

- [x] Root: `app/page.jsx`, `app/layout.jsx`, `app/error.jsx`, `app/not-found.jsx`, `app/loading.jsx` → `.tsx`
- [x] About: `app/about/page.jsx` → `.tsx`
- [x] Login: `app/login/page.jsx` → `.tsx`
- [x] Cabins: `app/cabins/page.jsx`, `app/cabins/[cabinId]/page.jsx`, etc. → `.tsx`
  - Type `params` and `searchParams`
  - Type `generateMetadata` and `generateStaticParams`
- [x] Account: `app/account/page.jsx`, `app/account/layout.jsx`, etc. → `.tsx`
- [x] Reservations: `app/account/reservations/page.jsx`, `app/account/reservations/edit/[bookingId]/page.jsx` → `.tsx`
- [x] Profile: `app/account/profile/page.jsx` → `.tsx`

### Phase 5: Strict Mode Resolution & Finalization

#### Common Errors Checklist

- [ ] **Null/undefined checks on Supabase query results**
  - `data` can be null; always check before use
  - Example: `if (!data) throw new Error("Not found")`

- [ ] **Optional chaining on session properties**
  - `session?.user?.guestId` may be undefined
  - Use type guards: `if (session?.user?.guestId) { ... }`

- [ ] **FormData type assertions**
  - `formData.get()` returns `FormDataEntryValue | null` (i.e., `string | File | null`)
  - **Recommended:** Use typed helpers from `types/server-actions.ts`:
    - `getFormString(formData, "field")` - required string with validation
    - `getFormNumber(formData, "field")` - required number with validation
    - `getFormOptionalString(formData, "field")` - optional string
  - Avoid raw casts like `formData.get("field") as string` (unsafe)

- [ ] **NextAuth callback type narrowing**
  - JWT callback: check `token.guestId` existence
  - Session callback: spread user properties safely

- [ ] **Date constructor arguments**
  - Ensure string dates are valid before `new Date()`

- [ ] **Array method return types**
  - `.find()` can return undefined
  - `.filter()` narrows types correctly

#### Finalization Steps

- [ ] Disable `allowJs` in tsconfig.json
- [ ] Verify no .js/.jsx files remain in app/ directory
  ```bash
  find app -name "*.js" -o -name "*.jsx" | wc -l  # Should be 0
  ```
- [ ] Run full validation suite:
  ```bash
  npm run lint
  npm run build
  npm run typecheck
  npm run test:unit
  npm run test:component
  ```

**Note:** `skipLibCheck: true` may mask issues in `@types/next-auth` or similar. If strange runtime errors occur, temporarily set to `false` to surface hidden type issues.

### Phase 6: Test Migration

- [ ] Unit tests: `tests/unit/*.test.js` → `.test.ts` (6 files)
  - `actions.test.js`
  - `api-cabins-route.test.js`
  - `booking-utils.test.js`
  - `data-service.test.js`
  - `errors.test.js`
  - `guest-utils.test.js`
- [ ] Component tests: `tests/component/*.test.jsx` → `.test.tsx` (10 files)
  - Type mock props and render results
- [ ] Update vitest.config.mts include patterns if needed
- [ ] Run full E2E test suite:
  ```bash
  npm run test:e2e
  ```

## Type Definitions Reference

### Domain Types (types/domain.ts)

```typescript
export interface Cabin {
  id: number;
  name: string;
  maxCapacity: number;
  regularPrice: number;
  discount: number;
  image: string;
  description?: string;
}

export interface Booking {
  id: number;
  cabinId: number;
  guestId: number;
  startDate: string;
  endDate: string;
  numNights: number;
  numGuests: number;
  cabinPrice: number;
  extrasPrice: number;
  totalPrice: number;
  status: 'unconfirmed' | 'checked-in' | 'checked-out' | 'canceled';
  hasBreakfast: boolean;
  isPaid: boolean;
  observations?: string;
  cabins?: Pick<Cabin, 'name' | 'maxCapacity' | 'image'>;
}

export interface Guest {
  id: number;
  email: string;
  fullName: string;
  nationalID?: string;
  nationality?: string;
  countryFlag?: string;
}

export interface Settings {
  id: number;
  minBookingLength: number;
  maxBookingLength: number;
  maxGuestsPerBooking: number;
  breakfastPrice: number;
}

export interface Country {
  name: string;
  flag: string;
}
```

### NextAuth Augmentation (types/next-auth.d.ts)

```typescript
import { DefaultSession, DefaultUser } from "next-auth";
import { DefaultJWT } from "next-auth/jwt";

declare module "next-auth" {
  interface Session {
    user: {
      guestId?: number;
    } & DefaultSession["user"];
  }
  interface User extends DefaultUser {
    guestId?: number;
  }
}

declare module "next-auth/jwt" {
  interface JWT extends DefaultJWT {
    guestId?: number;
  }
}
```

### Environment Types (types/env.d.ts)

```typescript
declare namespace NodeJS {
  interface ProcessEnv {
    NEXT_PUBLIC_SUPABASE_URL: string;
    NEXT_PUBLIC_SUPABASE_KEY: string;
    SUPABASE_URL?: string;
    SUPABASE_SERVICE_ROLE_KEY: string;
    AUTH_GOOGLE_ID: string;
    AUTH_GOOGLE_SECRET: string;
    NEXTAUTH_URL: string;
    NEXTAUTH_SECRET: string;
  }
}
```

### Server Actions Helper (types/server-actions.ts)

```typescript
/**
 * Type-safe Server Action result pattern
 */
export type ActionResult<T = void> =
  | { success: true; data: T }
  | { success: false; error: string };

/**
 * Helper to extract typed form data with automatic whitespace trimming.
 * All string values are trimmed to prevent subtle bugs from whitespace-only input.
 *
 * Note: FormData.get() returns FormDataEntryValue | null (string | File | null).
 * These helpers provide explicit error messages for each case.
 */
export function getFormString(formData: FormData, key: string): string {
  const value = formData.get(key);
  if (value === null) {
    throw new Error(`Form field is missing: ${key}`);
  }
  if (typeof value !== "string") {
    throw new Error(`Expected string for form field: ${key}, got File`);
  }
  const trimmed = value.trim();
  if (!trimmed) {
    throw new Error(`Form field is empty: ${key}`);
  }
  return trimmed;
}

export function getFormNumber(formData: FormData, key: string): number {
  const value = getFormString(formData, key);
  const num = Number(value);
  // Reject NaN and Infinity values
  if (Number.isNaN(num) || !Number.isFinite(num)) {
    throw new Error(`Expected number for form field: ${key}`);
  }
  return num;
}

export function getFormOptionalString(
  formData: FormData,
  key: string
): string | undefined {
  const value = formData.get(key);
  if (value === null) return undefined;
  if (typeof value !== "string") {
    throw new Error(`Expected string for form field: ${key}, got File`);
  }
  const trimmed = value.trim();
  return trimmed || undefined;
}

/**
 * Example usage in Server Action:
 *
 * "use server";
 * import { getFormString, getFormNumber, ActionResult } from "@/types/server-actions";
 *
 * export async function createBooking(formData: FormData): Promise<ActionResult<{ id: number }>> {
 *   try {
 *     const cabinId = getFormNumber(formData, "cabinId");
 *     const observations = getFormOptionalString(formData, "observations");
 *     // ... create booking
 *     return { success: true, data: { id: newBooking.id } };
 *   } catch (error) {
 *     return { success: false, error: error instanceof Error ? error.message : "Unknown error" };
 *   }
 * }
 */
```

## Testing and Validation

### Per-Phase Validation

After each phase:
```bash
npm run lint        # ESLint
npm run build       # Next.js build
npm run typecheck   # tsc --noEmit
```

### Final Validation

```bash
npm run lint
npm run build
npm run typecheck
npm run test:unit
npm run test:component
npm run test:e2e
```

## Risks and Edge Cases

### High Risk

1. **Server Actions Type Safety**
   - `"use server"` files require careful FormData typing
   - Return types must be serializable
   - **Mitigation:** Use `types/server-actions.ts` helpers and `ActionResult<T>` pattern

2. **NextAuth Callbacks**
   - JWT and session callbacks need proper type narrowing
   - **Mitigation:** Use type guards for token properties

3. **Supabase Type Regeneration**
   - Schema changes require type regeneration
   - **Mitigation:** Add `supabase gen types` to CI or pre-commit

### Medium Risk

4. **Date Handling**
   - `date-fns` functions expect specific types
   - Booking date ranges need careful null handling
   - **Mitigation:** Create utility types for date ranges

5. **ReservationContext**
   - Context value includes DateRange from react-day-picker
   - **Mitigation:** Import types from react-day-picker

6. **Dynamic Route Params**
   - `params` is now a Promise in Next.js 15 (future consideration)
   - **Mitigation:** Follow Next.js upgrade guide when upgrading

### Low Risk

7. **allowJs Removal**
   - Forgetting to convert a file will cause build failure
   - **Mitigation:** Run `find app -name "*.js" -o -name "*.jsx"` to verify

8. **Test Mock Types**
   - vi.mock and vi.fn need type annotations
   - **Mitigation:** Use `vi.fn<[], ReturnType>()` pattern

### Operational Risks

9. **CI/CD Integration**
   - TypeScript errors may slip into production if CI doesn't enforce typecheck
   - **Mitigation:** Add `npm run typecheck` to CI pipeline before build step
   - **Strongly recommended:** Add pre-commit hook with `lint-staged` to catch type errors locally before CI
     ```bash
     # Install husky and lint-staged
     npm install -D husky lint-staged
     npx husky init
     echo "npx lint-staged" > .husky/pre-commit
     ```
     ```json
     // package.json
     "lint-staged": {
       "*.{ts,tsx}": ["tsc --noEmit --skipLibCheck"]
     }
     ```
   - This prevents broken code from being committed and reduces CI feedback loop time

10. **Team Coordination**
    - In-flight PRs during migration may conflict with file renames
    - **Mitigation:**
      - Announce migration start to team
      - Merge or close long-running PRs before Phase 2
      - Consider feature freeze during active migration phases
      - Use atomic commits per file/group for easy cherry-picking

11. **Build Performance**
    - `tsc --noEmit` can add 10-30 seconds to builds
    - **Mitigation:**
      - Use `incremental: true` in tsconfig (already included)
      - Monitor typecheck duration; alert if >30 seconds
      - Consider `typescript-coverage-report` to track progress

12. **@types/* Version Conflicts**
    - Strict mode may surface conflicts between @types packages
    - **Mitigation:**
      - Pin specific @types versions if conflicts arise
      - Use `skipLibCheck: true` (already included) to avoid .d.ts conflicts
      - If needed, create local type declarations to override

## Troubleshooting: @types/* Conflicts

If you encounter type errors from `@types/*` packages during strict migration:

1. **Identify the conflict:**
   ```bash
   npm run typecheck 2>&1 | grep "node_modules/@types"
   ```

2. **Try version bump:**
   ```bash
   npm update @types/[package-name]
   ```

3. **Pin specific version (if needed):**
   ```json
   "@types/problematic-package": "1.2.3"
   ```

4. **Create local override (last resort):**
   ```typescript
   // types/overrides.d.ts
   declare module "problematic-package" {
     // Custom type declarations
   }
   ```

5. **Temporary workaround:**
   - Keep `skipLibCheck: true` (already set)
   - File issue with @types package maintainer

## Open Questions

- None at this time.

## Rollback Strategy

If issues arise during migration:

1. Keep `allowJs: true` until all files are converted
2. Revert individual file renames (`.ts` → `.js`) if needed
3. Remove TypeScript dependencies and tsconfig.json to fully rollback

## Success Criteria

### Functional

- [ ] All 56 app files converted to TypeScript
- [ ] All 16 test files converted to TypeScript
- [ ] `npm run typecheck` passes with no errors
- [ ] `npm run build` succeeds
- [ ] `npm run lint` passes
- [ ] All unit tests pass (77+ tests)
- [ ] All component tests pass
- [ ] All E2E tests pass
- [ ] `allowJs: false` in tsconfig.json
- [ ] No `.js` or `.jsx` files in `app/` directory

### Performance

- [ ] `tsc --noEmit` completes in <30 seconds
- [ ] `npm run build` time regression <10% from baseline

### Quality

- [ ] No `any` types except in explicitly annotated exceptions
- [ ] All Server Actions use typed helpers
- [ ] No new ESLint warnings introduced by migration

### Style Guide for `any` Type Exceptions

When `any` is unavoidable (e.g., third-party library interop), use this format:

```typescript
// eslint-disable-next-line @typescript-eslint/no-explicit-any -- [reason]
const handler = (event: any) => { ... };
```

**Required:**
- Use `eslint-disable-next-line` (not `@ts-ignore`)
- Include `-- [reason]` explaining why `any` is necessary
- Prefer `unknown` over `any` when possible, then narrow with type guards

**Examples of valid reasons:**
- `-- Third-party library X lacks types`
- `-- React event handler type conflict with form submission`
- `-- JSON.parse return type before validation`
