---
name: typescript-migration-plan
description: Next.js App Router TS migration plan (phased)
updated: 2025-12-30
---

# Plan

## Summary

Migrate the existing Next.js 14 App Router codebase from JavaScript to TypeScript without changing runtime behavior. Enable strict type checking from the start, introduce shared domain types and generated Supabase types, then convert files from the data layer outward to UI. Finish by disabling allowJs and validating build/lint/typecheck.

## Requirements

- Preserve current behavior and routing; type additions only
- Enable strict type checking from day one
- Generate Supabase types via `supabase gen types`
- Keep allowJs enabled during the migration, then disable it after completion
- Ensure `next build`, `next lint`, and `tsc --noEmit` succeed
- All existing tests must pass after migration

## Scope

### In Scope

- `app/**/*.js`, `app/**/*.jsx` (56 files)
- `app/_lib/**/*.js` (8 files: actions, auth, booking, data-service, errors, guest, supabaseBrowser, supabaseServer)
- `app/_components/**/*.jsx` (27 files)
- `app/api/**/route.js` (3 files)
- `middleware.js`
- `package.json`, `jsconfig.json` → `tsconfig.json`
- `tests/unit/**/*.test.js` (6 files)
- `tests/component/**/*.test.jsx` (10 files)

### Out of Scope

- DB/schema changes, auth provider changes, UI/UX redesign, new features
- Config files: `next.config.mjs`, `postcss.config.mjs`, `tailwind.config.js` (keep as JS)

### Already TypeScript (No Action Needed)

- `vitest.config.mts` ✓
- `playwright.config.ts` ✓
- `tests/setup.ts` ✓
- `tests/msw/handlers.ts` ✓
- `tests/msw/server.ts` ✓
- `next-env.d.ts` ✓ (auto-generated by Next.js)

## Files and Entry Points

### New Files to Create

- `tsconfig.json` (from jsconfig.json, with strict options)
- `types/domain.ts` (Cabin, Booking, Guest, Settings, Country)
- `types/supabase.ts` (generated via supabase gen types)
- `types/next-auth.d.ts` (module augmentation for session.user.guestId)
- `types/env.d.ts` (environment variable types)

### Files to Migrate

| Layer | Files | Priority |
|-------|-------|----------|
| Data/Auth | `app/_lib/*.js` (8 files) | Phase 2 |
| API Routes | `app/api/**/route.js` (3 files) | Phase 3 |
| Middleware | `middleware.js` | Phase 3 |
| Components | `app/_components/*.jsx` (27 files) | Phase 4 |
| Pages/Layouts | `app/**/page.jsx`, `layout.jsx`, etc. (18 files) | Phase 4 |
| Unit Tests | `tests/unit/*.test.js` (6 files) | Phase 6 |
| Component Tests | `tests/component/*.test.jsx` (10 files) | Phase 6 |

## Data Model / API Changes

- Generate Supabase Database types and use `createClient<Database>()`
- Add domain-level types for app-specific models and view models
- Add NextAuth module augmentation to extend `session.user.guestId` and `token.guestId`
- No runtime/API behavior changes; types only

## Dependencies

### To Install

```bash
npm install -D typescript @types/node @types/react @types/react-dom
```

### Already Typed (No @types needed)

- `@supabase/supabase-js` - TypeScript native
- `date-fns` v3 - TypeScript native
- `react-day-picker` - TypeScript native
- `@heroicons/react` - TypeScript native
- `next-auth` - TypeScript native
- `msw` - TypeScript native
- `vitest` - TypeScript native
- `@playwright/test` - TypeScript native
- `@testing-library/react` - TypeScript native

## Phase-by-Phase Action Items

### Phase 1: Foundation Setup

- [ ] Install TypeScript dependencies
  ```bash
  npm install -D typescript @types/node @types/react @types/react-dom
  ```
- [ ] Create `tsconfig.json` with strict settings
  ```json
  {
    "compilerOptions": {
      "target": "ES2017",
      "lib": ["dom", "dom.iterable", "esnext"],
      "allowJs": true,
      "checkJs": false,
      "skipLibCheck": true,
      "strict": true,
      "noEmit": true,
      "esModuleInterop": true,
      "module": "esnext",
      "moduleResolution": "bundler",
      "resolveJsonModule": true,
      "isolatedModules": true,
      "jsx": "preserve",
      "incremental": true,
      "plugins": [{ "name": "next" }],
      "baseUrl": ".",
      "paths": { "@/*": ["./*"] }
    },
    "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts", "types/**/*.ts"],
    "exclude": ["node_modules"]
  }
  ```
- [ ] Add `typecheck` script to package.json
  ```json
  "typecheck": "tsc --noEmit"
  ```
- [ ] Create `types/` directory structure
- [ ] Generate Supabase types
  ```bash
  supabase gen types typescript --linked > types/supabase.ts
  ```
- [ ] Create `types/domain.ts` with app-specific types
- [ ] Create `types/next-auth.d.ts` for session augmentation
- [ ] Create `types/env.d.ts` for environment variables

### Phase 2: Data/Auth Layer (.js → .ts)

- [ ] `app/_lib/supabaseServer.js` → `.ts`
  - Add `Database` generic to createClient
- [ ] `app/_lib/supabaseBrowser.js` → `.ts`
  - Add `Database` generic to createClient
- [ ] `app/_lib/errors.js` → `.ts`
  - Type BookingError class and mapSupabaseError function
- [ ] `app/_lib/guest.js` → `.ts`
  - Type normalizeNationalId function
- [ ] `app/_lib/booking.js` → `.ts`
  - Type validateBookingInput and related functions
- [ ] `app/_lib/data-service.js` → `.ts`
  - Type all data fetching functions (getCabins, getBooking, etc.)
- [ ] `app/_lib/auth.js` → `.ts`
  - Type NextAuth config and callbacks
- [ ] `app/_lib/actions.js` → `.ts`
  - Type Server Actions with FormData handling
  - Handle `"use server"` directive

### Phase 3: API Routes & Middleware

- [ ] `middleware.js` → `middleware.ts`
  - Type withAuth config
- [ ] `app/api/auth/[...nextauth]/route.js` → `.ts`
  - Type route handlers
- [ ] `app/api/cabins/[cabinId]/route.js` → `.ts`
  - Type params and response
- [ ] `app/api/health/route.js` → `.ts`
  - Type response

### Phase 4: Components & Pages (.jsx → .tsx)

#### Components (27 files)

- [ ] Context: `ReservationContext.jsx` → `.tsx`
  - Define context type with DateRange
- [ ] Forms: `UpdateProfileForm.jsx`, `ReservationForm.jsx` → `.tsx`
  - Type form props and Server Action bindings
- [ ] Cards: `CabinCard.jsx`, `ReservationCard.jsx` → `.tsx`
- [ ] Lists: `CabinList.jsx`, `ReservationList.jsx` → `.tsx`
- [ ] Navigation: `Navigation.jsx`, `NavigationMenu.jsx`, `SideNavigation.jsx` → `.tsx`
- [ ] Auth: `SignInButton.jsx`, `SignOutButton.jsx` → `.tsx`
- [ ] UI: `Spinner.jsx`, `SpinnerMini.jsx`, `SubmitButton.jsx`, etc. → `.tsx`
- [ ] Other: `Cabin.jsx`, `DateSelector.jsx`, `Filter.jsx`, `Header.jsx`, `Logo.jsx`, etc. → `.tsx`

#### Pages & Layouts (18 files)

- [ ] Root: `app/page.jsx`, `app/layout.jsx`, `app/error.jsx`, `app/not-found.jsx`, `app/loading.jsx` → `.tsx`
- [ ] About: `app/about/page.jsx` → `.tsx`
- [ ] Login: `app/login/page.jsx` → `.tsx`
- [ ] Cabins: `app/cabins/page.jsx`, `app/cabins/[cabinId]/page.jsx`, etc. → `.tsx`
  - Type `params` and `searchParams`
  - Type `generateMetadata` and `generateStaticParams`
- [ ] Account: `app/account/page.jsx`, `app/account/layout.jsx`, etc. → `.tsx`
- [ ] Reservations: `app/account/reservations/page.jsx`, `app/account/reservations/edit/[bookingId]/page.jsx` → `.tsx`
- [ ] Profile: `app/account/profile/page.jsx` → `.tsx`

### Phase 5: Strict Mode Resolution & Finalization

- [ ] Resolve all strict TypeScript errors
  - Add explicit null checks
  - Add type guards where needed
  - Handle optional chaining properly
- [ ] Disable `allowJs` in tsconfig.json
- [ ] Verify no .js/.jsx files remain in app/ directory
- [ ] Run full validation suite:
  ```bash
  npm run lint
  npm run build
  npm run typecheck
  npm run test:unit
  npm run test:component
  ```

### Phase 6: Test Migration

- [ ] Unit tests: `tests/unit/*.test.js` → `.test.ts` (6 files)
  - `actions.test.js`
  - `api-cabins-route.test.js`
  - `booking-utils.test.js`
  - `data-service.test.js`
  - `errors.test.js`
  - `guest-utils.test.js`
- [ ] Component tests: `tests/component/*.test.jsx` → `.test.tsx` (10 files)
  - Type mock props and render results
- [ ] Update vitest.config.mts include patterns if needed
- [ ] Run full E2E test suite:
  ```bash
  npm run test:e2e
  ```

## Type Definitions Reference

### Domain Types (types/domain.ts)

```typescript
export interface Cabin {
  id: number;
  name: string;
  maxCapacity: number;
  regularPrice: number;
  discount: number;
  image: string;
  description?: string;
}

export interface Booking {
  id: number;
  cabinId: number;
  guestId: number;
  startDate: string;
  endDate: string;
  numNights: number;
  numGuests: number;
  cabinPrice: number;
  extrasPrice: number;
  totalPrice: number;
  status: 'unconfirmed' | 'checked-in' | 'checked-out' | 'canceled';
  hasBreakfast: boolean;
  isPaid: boolean;
  observations?: string;
  cabins?: Pick<Cabin, 'name' | 'maxCapacity' | 'image'>;
}

export interface Guest {
  id: number;
  email: string;
  fullName: string;
  nationalID?: string;
  nationality?: string;
  countryFlag?: string;
}

export interface Settings {
  id: number;
  minBookingLength: number;
  maxBookingLength: number;
  maxGuestsPerBooking: number;
  breakfastPrice: number;
}

export interface Country {
  name: string;
  flag: string;
}
```

### NextAuth Augmentation (types/next-auth.d.ts)

```typescript
import { DefaultSession, DefaultUser } from "next-auth";
import { DefaultJWT } from "next-auth/jwt";

declare module "next-auth" {
  interface Session {
    user: {
      guestId?: number;
    } & DefaultSession["user"];
  }
  interface User extends DefaultUser {
    guestId?: number;
  }
}

declare module "next-auth/jwt" {
  interface JWT extends DefaultJWT {
    guestId?: number;
  }
}
```

### Environment Types (types/env.d.ts)

```typescript
declare namespace NodeJS {
  interface ProcessEnv {
    NEXT_PUBLIC_SUPABASE_URL: string;
    NEXT_PUBLIC_SUPABASE_KEY: string;
    SUPABASE_URL?: string;
    SUPABASE_SERVICE_ROLE_KEY: string;
    AUTH_GOOGLE_ID: string;
    AUTH_GOOGLE_SECRET: string;
    NEXTAUTH_URL: string;
    NEXTAUTH_SECRET: string;
  }
}
```

## Testing and Validation

### Per-Phase Validation

After each phase:
```bash
npm run lint        # ESLint
npm run build       # Next.js build
npm run typecheck   # tsc --noEmit
```

### Final Validation

```bash
npm run lint
npm run build
npm run typecheck
npm run test:unit
npm run test:component
npm run test:e2e
```

## Risks and Edge Cases

### High Risk

1. **Server Actions Type Safety**
   - `"use server"` files require careful FormData typing
   - Return types must be serializable
   - Solution: Create typed wrapper functions

2. **NextAuth Callbacks**
   - JWT and session callbacks need proper type narrowing
   - Solution: Use type guards for token properties

3. **Supabase Type Regeneration**
   - Schema changes require type regeneration
   - Solution: Add `supabase gen types` to CI or pre-commit

### Medium Risk

4. **Date Handling**
   - `date-fns` functions expect specific types
   - Booking date ranges need careful null handling
   - Solution: Create utility types for date ranges

5. **ReservationContext**
   - Context value includes DateRange from react-day-picker
   - Solution: Import types from react-day-picker

6. **Dynamic Route Params**
   - `params` is now a Promise in Next.js 15 (future consideration)
   - Solution: Follow Next.js upgrade guide when upgrading

### Low Risk

7. **allowJs Removal**
   - Forgetting to convert a file will cause build failure
   - Solution: Run `find app -name "*.js" -o -name "*.jsx"` to verify

8. **Test Mock Types**
   - vi.mock and vi.fn need type annotations
   - Solution: Use `vi.fn<[], ReturnType>()` pattern

## Open Questions

- None at this time.

## Rollback Strategy

If issues arise during migration:

1. Keep `allowJs: true` until all files are converted
2. Revert individual file renames (`.ts` → `.js`) if needed
3. Remove TypeScript dependencies and tsconfig.json to fully rollback

## Success Criteria

- [ ] All 56 app files converted to TypeScript
- [ ] All 16 test files converted to TypeScript
- [ ] `npm run typecheck` passes with no errors
- [ ] `npm run build` succeeds
- [ ] `npm run lint` passes
- [ ] All unit tests pass (77+ tests)
- [ ] All component tests pass
- [ ] All E2E tests pass
- [ ] `allowJs: false` in tsconfig.json
- [ ] No `.js` or `.jsx` files in `app/` directory
