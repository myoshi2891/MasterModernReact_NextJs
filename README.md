# ğŸ•ï¸ The Wild Oasis - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

[![Ask DeepWiki](https://deepwiki.com/badge.svg)](https://deepwiki.com/myoshi2891/MasterModernReact_NextJs)

## ğŸ“‹ ç›®æ¬¡

- [æ¦‚è¦](#æ¦‚è¦)
- [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](#æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯)
- [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ§‹æˆ](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ§‹æˆ)
- [ã‚³ã‚¢æ©Ÿèƒ½ã‚·ã‚¹ãƒ†ãƒ ](#ã‚³ã‚¢æ©Ÿèƒ½ã‚·ã‚¹ãƒ†ãƒ )
- [ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ](#ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ )
- [çµ±åˆãƒã‚¤ãƒ³ãƒˆ](#çµ±åˆãƒã‚¤ãƒ³ãƒˆ)
- [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–)
- [é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼](#é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼)
- [å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³é›†](#å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³é›†)
- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
- [ãƒ†ã‚¹ãƒˆ](#ãƒ†ã‚¹ãƒˆ)
- [ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ](#ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ)

---

## æ¦‚è¦

### ğŸ¯ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç›®çš„

**The Wild Oasis** ã¯ã€Next.js ãƒ™ãƒ¼ã‚¹ã®ãƒ©ã‚°ã‚¸ãƒ¥ã‚¢ãƒªãƒ¼ã‚­ãƒ£ãƒ“ãƒ³äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚ã‚²ã‚¹ãƒˆãŒé«˜ç´šã‚­ãƒ£ãƒ“ãƒ³ã‚’é–²è¦§ã—ã€ç©ºå®¤ç¢ºèªã€äºˆç´„ã€äºˆç´„ç®¡ç†ã‚’çµ±åˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§å®Ÿæ–½ã§ãã¾ã™ã€‚

#### ğŸŒŸ ä¸»è¦æ©Ÿèƒ½

| æ©Ÿèƒ½             | èª¬æ˜                           |
| ---------------- | ------------------------------ |
| ã‚­ãƒ£ãƒ“ãƒ³é–²è¦§     | å®¹é‡ãƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¯¾å¿œ |
| ç©ºå®¤ç¢ºèª         | æ—¥ä»˜ãƒ™ãƒ¼ã‚¹ã®äºˆç´„ãƒã‚§ãƒƒã‚¯       |
| äºˆç´„ã‚·ã‚¹ãƒ†ãƒ      | ç›´æ„Ÿçš„ãªæ—¥ä»˜é¸æŠ UI            |
| Google OAuth     | ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³çµ±åˆ         |
| ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç† | å›½é¸æŠãªã©ã®ã‚²ã‚¹ãƒˆæƒ…å ±ç®¡ç†     |
| äºˆç´„ç®¡ç†         | é–²è¦§ãƒ»ç·¨é›†ãƒ»å‰Šé™¤æ©Ÿèƒ½           |
| ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–     | Supabase PostgreSQL            |

---

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ğŸ“¦ ã‚³ã‚¢ä¾å­˜é–¢ä¿‚

| ã‚«ãƒ†ã‚´ãƒª       | æŠ€è¡“                  | ãƒãƒ¼ã‚¸ãƒ§ãƒ³     | ç›®çš„                               |
| -------------- | --------------------- | -------------- | ---------------------------------- |
| ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | Next.js               | 14.2.32        | App Routerã€Server Componentsã€ISR |
| UI ãƒ©ã‚¤ãƒ–ãƒ©ãƒª  | React                 | ^18            | ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ UIã€SSR å¯¾å¿œ  |
| èªè¨¼           | next-auth             | ^5.0.0-beta.23 | OAuth çµ±åˆã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†         |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹   | @supabase/supabase-js | ^2.56.0        | PostgreSQLã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½       |
| ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°   | Tailwind CSS          | ^3.4.1         | ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ CSS       |
| ã‚¢ã‚¤ã‚³ãƒ³       | @heroicons/react      | ^2.1.5         | React ç”¨ã‚¢ã‚¤ã‚³ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒª         |
| æ—¥ä»˜å‡¦ç†       | date-fns              | ^3.6.0         | æ—¥ä»˜æ“ä½œãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£             |
| æ—¥ä»˜ãƒ”ãƒƒã‚«ãƒ¼   | react-day-picker      | ^8.10.1        | ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ       |

### ğŸ§ª é–‹ç™ºç”¨ä¾å­˜é–¢ä¿‚

| ã‚«ãƒ†ã‚´ãƒª             | æŠ€è¡“                   | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç›®çš„                           |
| -------------------- | ---------------------- | ---------- | ------------------------------ |
| E2E ãƒ†ã‚¹ãƒˆ           | @playwright/test       | ^1.55.1    | ãƒ–ãƒ©ã‚¦ã‚¶çµ±åˆãƒ†ã‚¹ãƒˆ             |
| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆ | @testing-library/react | ^16.3.0    | React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå˜ä½“ãƒ†ã‚¹ãƒˆ |
| ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ       | vitest                 | ^3.2.4     | ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆç”¨ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ |
| API ãƒ¢ãƒƒã‚¯           | msw                    | ^2.11.3    | ãƒ†ã‚¹ãƒˆç”¨ API ãƒ¢ãƒƒã‚­ãƒ³ã‚°        |
| Lint è¨­å®š            | eslint-config-next     | 14.2.5     | Next.js ESLint è¨­å®š            |

### ğŸ”§ ç’°å¢ƒè¦ä»¶

```bash
Node.js: >=20.19.0 <21
npm: 10.xä»¥ä¸Šæ¨å¥¨
```

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ§‹æˆ

### ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```mermaid
flowchart TD
CabinMgmt[Cabins Management]
AccountMgmt[Account Management]
ReservMgmt[Reservation System]
CabinMgmt --> ResContext
AccountMgmt --> ResContext
ReservMgmt --> ResContext
ResContext[ReservationContext Client State]
ResContext --> ServerAction
ServerAction[Server Actions Mutations]
ServerAction --> Supabase
Supabase[Supabase PostgreSQL Database]
```

### ğŸ”„ å®Œå…¨ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ-ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
Browser[Browser User GET Request]
Router[Next.js Router Matcher]
Static[generateStaticParams Check]
CDN[Static Page CDN Cache]
Query[getCabin Server Query]
Render[React Server Component]
HTML[HTML plus Client JS]
Hydrate[Browser Hydration]
Interact[User Interaction]
Browser --> Router
Router --> Static
Static --> CDN
CDN --> Query
Query --> Render
Render --> HTML
HTML --> Hydrate
Hydrate --> Interact
```

---

## ã‚³ã‚¢æ©Ÿèƒ½ã‚·ã‚¹ãƒ†ãƒ 

### 1ï¸âƒ£ ã‚­ãƒ£ãƒ“ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

#### ğŸ“ è²¬å‹™

ã‚­ãƒ£ãƒ“ãƒ³ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºã¨ç©ºå®¤ç¢ºèªã‚’å¤šå±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ç®¡ç†ã—ã¾ã™ã€‚

#### ğŸ“Š å‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

```mermaid
flowchart TD
A[CabinList Server Component]
B[Filter Client Component]
C[getBookedDatesByCabinId]
D[Supabase Query]
E[CabinCard Rendering]
F[Static ISR Output]
A --> B
B --> C
C --> D
D --> E
E --> F
```

#### ğŸ”— ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```javascript
// app/cabins/page.js - ã‚­ãƒ£ãƒ“ãƒ³ä¸€è¦§ï¼ˆServer Componentï¼‰
export const revalidate = 3600;

export default async function CabinsPage({ searchParams }) {
  const capacity = searchParams?.capacity;
  let cabins = await getCabins();

  if (capacity) {
    cabins = cabins.filter(c => c.maxCapacity >= Number(capacity));
  }

  return (
    <div className="grid gap-8">
      {cabins.map(cabin => (
        <CabinCard key={cabin.id} cabin={cabin} />
      ))}
    </div>
  );
}

// app/cabins/[cabinId]/page.js
export async function generateStaticParams() {
  const cabins = await getCabins();
  return cabins.map(cabin => ({ cabinId: String(cabin.id) }));
}

export default async function CabinPage({ params }) {
  const cabin = await getCabin(params.cabinId);
  const reservations = await getReservations(params.cabinId);

  return (
    <>
      <Cabin cabin={cabin} />
      <ReservationForm cabin={cabin} reservations={reservations} />
    </>
  );
}
```

#### âš™ï¸ ä¸»è¦é–¢æ•°

| é–¢æ•°                    | ãƒ•ã‚¡ã‚¤ãƒ«          | èª¬æ˜                | æˆ»ã‚Šå€¤      |
| ----------------------- | ----------------- | ------------------- | ----------- |
| getCabins               | data-service.js   | å…¨ã‚­ãƒ£ãƒ“ãƒ³å–å¾—      | Cabin[]     |
| getCabin                | data-service.js   | ID æŒ‡å®šã‚­ãƒ£ãƒ“ãƒ³å–å¾— | Cabin       |
| getBookedDatesByCabinId | data-service.js   | äºˆç´„æ¸ˆã¿æ—¥ä»˜å–å¾—    | Date[]      |
| generateStaticParams    | [cabinId]/page.js | ãƒ“ãƒ«ãƒ‰æ™‚é™çš„ç”Ÿæˆ    | {cabinId}[] |

---

### 2ï¸âƒ£ äºˆç´„ãƒ»ãƒ–ãƒƒã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 

#### ğŸ“ è²¬å‹™

æ—¥ä»˜é¸æŠã‹ã‚‰ç¢ºèªã¾ã§ã®äºˆç´„ãƒ•ãƒ­ãƒ¼ã‚’ç®¡ç†ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ»ã‚µãƒ¼ãƒãƒ¼é–“ã®çŠ¶æ…‹åŒæœŸã‚’å®Ÿç¾ã—ã¾ã™ã€‚

#### ğŸ”„ çŠ¶æ…‹ãƒ•ãƒ­ãƒ¼å›³

```mermaid
flowchart TD
Provider[ReservationProvider Root Layout]
State1[State range from to]
State2[setRange function]
State3[resetRange function]
DateSel[DateSelector Client]
ReservForm[ReservationForm Client]
Price[Calculate totalPrice]
Action[createBooking Server Action]
Provider --> State1
Provider --> State2
Provider --> State3
State1 --> DateSel
State1 --> ReservForm
State2 --> DateSel
ReservForm --> Price
Price --> Action
```

#### ğŸ”— ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

```javascript
// app/_components/ReservationContext.js
'use client';

import { createContext, useState } from 'react';

export const ReservationContext = createContext();

export function ReservationProvider({ children }) {
  const [range, setRange] = useState({ from: null, to: null });

  const resetRange = () => {
    setRange({ from: null, to: null });
  };

  return (
    <ReservationContext.Provider value={{ range, setRange, resetRange }}>
      {children}
    </ReservationContext.Provider>
  );
}

// app/_components/DateSelector.js
'use client';

import { DayPicker } from 'react-day-picker';
import { useContext } from 'react';
import { ReservationContext } from './ReservationContext';

export default function DateSelector({ cabin, bookedDates }) {
  const { range, setRange } = useContext(ReservationContext);
  const disabled = bookedDates.map(date => new Date(date));

  return (
    <DayPicker
      mode="range"
      selected={range}
      onSelect={setRange}
      disabled={disabled}
      min={2}
      max={180}
    />
  );
}

// app/_components/ReservationForm.js
'use client';

import { useContext, useState } from 'react';
import { ReservationContext } from './ReservationContext';
import { createBooking } from '@/app/_lib/actions';

export default function ReservationForm({ cabin, reservations }) {
  const { range } = useContext(ReservationContext);
  const [numGuests, setNumGuests] = useState(cabin.maxCapacity);
  const [observations, setObservations] = useState('');

  const nights = range?.from && range?.to
    ? Math.floor((range.to - range.from) / (1000 * 60 * 60 * 24))
    : 0;
  const totalPrice = nights * cabin.regularPrice;

  const handleSubmit = async (e) => {
    e.preventDefault();

    try {
      await createBooking({
        cabinId: cabin.id,
        startDate: range.from,
        endDate: range.to,
        numGuests,
        observations,
        totalPrice,
      });
    } catch (error) {
      console.error('äºˆç´„ã‚¨ãƒ©ãƒ¼:', error);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="bg-white p-6 rounded-lg">
      <div className="mb-4">
        <label>ã‚²ã‚¹ãƒˆæ•°: {numGuests}</label>
        <input
          type="range"
          min={1}
          max={cabin.maxCapacity}
          value={numGuests}
          onChange={(e) => setNumGuests(Number(e.target.value))}
        />
      </div>

      <div className="mb-4">
        <label>å‚™è€ƒ</label>
        <textarea
          value={observations}
          onChange={(e) => setObservations(e.target.value)}
          placeholder="ç‰¹åˆ¥ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã‚Œã°è¨˜å…¥ã—ã¦ãã ã•ã„"
        />
      </div>

      <div className="text-2xl font-bold mb-4">
        Â¥{totalPrice.toLocaleString()}
      </div>

      <button
        type="submit"
        disabled={!range?.from || !range?.to}
        className="w-full bg-blue-600 text-white py-2 rounded"
      >
        äºˆç´„ç¢ºå®š
      </button>
    </form>
  );
}
```

#### ğŸš€ Server Action: createBooking()

```javascript
"use server";

import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";
import { auth } from "./auth";
import { supabaseAdmin } from "./supabase";

export async function createBooking(bookingData) {
  const session = await auth();
  if (!session) throw new Error("èªè¨¼ãŒå¿…è¦ã§ã™");

  if (!bookingData.cabinId || !bookingData.startDate || !bookingData.endDate) {
    throw new Error("å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™");
  }

  if (new Date(bookingData.startDate) >= new Date(bookingData.endDate)) {
    throw new Error("çµ‚äº†æ—¥ã¯é–‹å§‹æ—¥ã‚ˆã‚Šå¾Œã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™");
  }

  const { data: conflicts } = await supabaseAdmin
    .from("bookings")
    .select("id")
    .eq("cabinId", bookingData.cabinId)
    .or(
      `and(startDate.lte.${bookingData.endDate},` +
        `endDate.gte.${bookingData.startDate})`
    );

  if (conflicts && conflicts.length > 0) {
    throw new Error("ã“ã®æœŸé–“ã¯æ—¢ã«äºˆç´„ã•ã‚Œã¦ã„ã¾ã™");
  }

  const { error: insertError } = await supabaseAdmin.from("bookings").insert([
    {
      cabinId: bookingData.cabinId,
      guestId: session.user.id,
      startDate: bookingData.startDate,
      endDate: bookingData.endDate,
      numGuests: bookingData.numGuests,
      observations: bookingData.observations,
      totalPrice: bookingData.totalPrice,
      status: "confirmed",
      createdAt: new Date().toISOString(),
    },
  ]);

  if (insertError) throw new Error("äºˆç´„ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");

  revalidatePath(`/cabins/${bookingData.cabinId}`);
  revalidatePath("/account/reservations");

  redirect(`/cabins/${bookingData.cabinId}/thankyou`);
}
```

---

### 3ï¸âƒ£ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

#### ğŸ“ è²¬å‹™

èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½ã‚’æä¾›ã—ã€ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

#### ğŸ” èªè¨¼ãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
User[User SignIn Click]
SignIn[signInAction Server]
OAuth[NextAuth OAuth Flow]
Google[Google OAuth]
Auth[User Authorizes]
Callback[NextAuth Callback]
JWT[JWT Token Gen]
Session[Session Create]
Cookie[Set Cookie Token]
Dashboard[Dashboard Route]
User --> SignIn
SignIn --> OAuth
OAuth --> Google
Google --> Auth
Auth --> Callback
Callback --> JWT
JWT --> Session
Session --> Cookie
Cookie --> Dashboard
```

#### ğŸ”§ å®Ÿè£…ã‚³ãƒ¼ãƒ‰

```javascript
// app/_lib/auth.js
import NextAuth from "next-auth";
import GoogleProvider from "next-auth/providers/google";

export const authConfig = {
  providers: [
    GoogleProvider({
      clientId: process.env.AUTH_GOOGLE_ID,
      clientSecret: process.env.AUTH_GOOGLE_SECRET,
      allowDangerousEmailAccountLinking: true,
    }),
  ],
  pages: {
    signIn: "/login",
  },
  callbacks: {
    async jwt({ token, user }) {
      if (user) token.id = user.id;
      return token;
    },

    async session({ session, token }) {
      session.user.id = token.id;
      return session;
    },

    authorized({ auth }) {
      return !!auth?.user;
    },
  },
};

export const { auth, signIn, signOut, handlers } = NextAuth(authConfig);
```

#### ğŸ›¡ï¸ ãƒ«ãƒ¼ãƒˆä¿è­·

```javascript
// middleware.js
import { auth } from "@/app/_lib/auth";

export const middleware = auth((request) => {
  const { pathname } = request.nextUrl;

  if (pathname.startsWith("/account")) {
    if (!request.auth) {
      const newUrl = new URL("/login", request.url);
      return Response.redirect(newUrl);
    }
  }

  return Response.next();
});

export const config = {
  matcher: ["/account/:path*"],
};
```

#### ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†

```javascript
// app/account/profile/page.js
import { auth } from "@/app/_lib/auth";
import { getGuest } from "@/app/_lib/data-service";
import UpdateProfileForm from "@/app/_components/UpdateProfileForm";

export default async function ProfilePage() {
  const session = await auth();
  if (!session?.user) redirect("/login");

  const guest = await getGuest(session.user.id);

  return (
    <div className="max-w-2xl">
      <h2 className="text-2xl font-bold mb-6">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†</h2>
      <UpdateProfileForm guest={guest} />
    </div>
  );
}

// Server Action
("use server");

export async function updateGuest(formData) {
  const session = await auth();
  if (!session?.user) throw new Error("èªè¨¼ãŒå¿…è¦ã§ã™");

  const { error } = await supabaseAdmin
    .from("guests")
    .update({
      fullName: formData.fullName,
      email: formData.email,
      country: formData.country,
      updatedAt: new Date().toISOString(),
    })
    .eq("id", session.user.id);

  if (error) throw new Error("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");

  revalidatePath("/account/profile");
}
```

#### ğŸ“‹ äºˆç´„ç®¡ç†

```javascript
// app/account/reservations/page.js
import { auth } from "@/app/_lib/auth";
import { getReservations } from "@/app/_lib/data-service";
import ReservationList from "@/app/_components/ReservationList";

export default async function ReservationsPage() {
  const session = await auth();
  if (!session?.user) redirect("/login");

  const reservations = await getReservations(session.user.id);

  return (
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">äºˆç´„å±¥æ­´</h2>
      {reservations.length === 0 ? (
        <p className="text-gray-500">äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“</p>
      ) : (
        <ReservationList reservations={reservations} userId={session.user.id} />
      )}
    </div>
  );
}

// Server Actions
("use server");

export async function updateBooking(bookingId, updates) {
  const session = await auth();
  if (!session?.user) throw new Error("èªè¨¼ãŒå¿…è¦ã§ã™");

  const { data: booking } = await supabaseAdmin
    .from("bookings")
    .select("guestId")
    .eq("id", bookingId)
    .single();

  if (booking.guestId !== session.user.id) {
    throw new Error("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
  }

  await supabaseAdmin
    .from("bookings")
    .update({ ...updates, updatedAt: new Date().toISOString() })
    .eq("id", bookingId);

  revalidatePath("/account/reservations");
}

export async function deleteBooking(bookingId) {
  const session = await auth();
  if (!session?.user) throw new Error("èªè¨¼ãŒå¿…è¦ã§ã™");

  const { data: booking } = await supabaseAdmin
    .from("bookings")
    .select("guestId, startDate")
    .eq("id", bookingId)
    .single();

  if (booking.guestId !== session.user.id) {
    throw new Error("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
  }

  if (new Date(booking.startDate) < new Date()) {
    throw new Error("ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å‰ã®äºˆç´„ã®ã¿å‰Šé™¤ã§ãã¾ã™");
  }

  await supabaseAdmin.from("bookings").delete().eq("id", bookingId);

  revalidatePath("/account/reservations");
}
```

---

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 

### ğŸ“‚ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
the-wild-oasis-website/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ layout.js
â”‚   â”œâ”€â”€ page.js
â”‚   â”œâ”€â”€ error.js
â”‚   â”œâ”€â”€ not-found.js
â”‚   â”œâ”€â”€ _components/
â”‚   â”‚   â”œâ”€â”€ Header.js
â”‚   â”‚   â”œâ”€â”€ Navigation.js
â”‚   â”‚   â”œâ”€â”€ ReservationProvider.js
â”‚   â”‚   â”œâ”€â”€ ReservationContext.js
â”‚   â”‚   â”œâ”€â”€ DateSelector.js
â”‚   â”‚   â”œâ”€â”€ ReservationForm.js
â”‚   â”‚   â”œâ”€â”€ Filter.js
â”‚   â”‚   â””â”€â”€ Spinner.js
â”‚   â”œâ”€â”€ _lib/
â”‚   â”‚   â”œâ”€â”€ actions.js
â”‚   â”‚   â”œâ”€â”€ auth.js
â”‚   â”‚   â”œâ”€â”€ data-service.js
â”‚   â”‚   â””â”€â”€ supabase.js
â”‚   â”œâ”€â”€ cabins/
â”‚   â”‚   â”œâ”€â”€ page.js
â”‚   â”‚   â”œâ”€â”€ [cabinId]/
â”‚   â”‚   â”‚   â””â”€â”€ page.js
â”‚   â”‚   â””â”€â”€ thankyou/
â”‚   â”‚       â””â”€â”€ page.js
â”‚   â”œâ”€â”€ account/
â”‚   â”‚   â”œâ”€â”€ layout.js
â”‚   â”‚   â”œâ”€â”€ page.js
â”‚   â”‚   â”œâ”€â”€ profile/
â”‚   â”‚   â”‚   â””â”€â”€ page.js
â”‚   â”‚   â””â”€â”€ reservations/
â”‚   â”‚       â”œâ”€â”€ page.js
â”‚   â”‚       â””â”€â”€ edit/[bookingId]/
â”‚   â”‚           â””â”€â”€ page.js
â”‚   â”œâ”€â”€ about/
â”‚   â”‚   â””â”€â”€ page.js
â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â””â”€â”€ page.js
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ auth/[...nextauth]/
â”‚           â””â”€â”€ route.js
â”œâ”€â”€ middleware.js
â”œâ”€â”€ public/
â”œâ”€â”€ package.json
â”œâ”€â”€ next.config.js
â”œâ”€â”€ tailwind.config.js
â”œâ”€â”€ jsconfig.json
â””â”€â”€ .eslintrc.json
```

### ğŸ”— ãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹è¨­å®š

```javascript
// jsconfig.json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./*"]
    },
    "target": "ES2020",
    "lib": ["ES2020", "DOM", "DOM.Iterable"]
  },
  "include": ["**/*.js", "**/*.jsx"],
  "exclude": ["node_modules"]
}
```

**åˆ©ç‚¹:**

```javascript
// âœ… Good - ç›¸å¯¾ãƒ‘ã‚¹ä¸è¦
import { auth } from "@/app/_lib/auth";
import { CabinCard } from "@/app/_components/CabinCard";

// âŒ Avoid - ç›¸å¯¾ãƒ‘ã‚¹ã®ç…©é›‘ã•
import { auth } from "../../app/_lib/auth";
import { CabinCard } from "../../../_components/CabinCard";
```

---

## çµ±åˆãƒã‚¤ãƒ³ãƒˆ

### ğŸŒ å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹çµ±åˆ

#### **1. Supabase PostgreSQL**

```javascript
// app/_lib/supabase.js
import { createClient } from "@supabase/supabase-js";

export const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
);

export function createAdminClient() {
  return createClient(
    process.env.SUPABASE_URL,
    process.env.SUPABASE_SERVICE_ROLE_KEY
  );
}

export const supabaseAdmin = createAdminClient();
```

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ:**

```sql
CREATE TABLE cabins (
  id BIGINT PRIMARY KEY,
  name TEXT NOT NULL,
  maxCapacity INT NOT NULL,
  regularPrice INT NOT NULL,
  discount INT,
  description TEXT,
  image TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE bookings (
  id BIGINT PRIMARY KEY,
  cabinId BIGINT REFERENCES cabins(id),
  guestId UUID REFERENCES guests(id),
  startDate DATE NOT NULL,
  endDate DATE NOT NULL,
  numGuests INT NOT NULL,
  totalPrice INT NOT NULL,
  status TEXT DEFAULT 'confirmed',
  observations TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE guests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT UNIQUE NOT NULL,
  fullName TEXT NOT NULL,
  country TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### **2. Google OAuth**

```javascript
// app/_lib/auth.js
import GoogleProvider from "next-auth/providers/google";

export const authConfig = {
  providers: [
    GoogleProvider({
      clientId: process.env.AUTH_GOOGLE_ID,
      clientSecret: process.env.AUTH_GOOGLE_SECRET,
    }),
  ],
};

// ç’°å¢ƒå¤‰æ•°
// AUTH_GOOGLE_ID=your_client_id.apps.googleusercontent.com
// AUTH_GOOGLE_SECRET=your_secret
// AUTH_SECRET=$(openssl rand -base64 32)
```

#### **3. RestCountries API**

```javascript
// app/_lib/data-service.js
export async function getCountries() {
  try {
    const res = await fetch("https://restcountries.com/v3.1/all", {
      next: { revalidate: 604800, tags: ["countries"] },
    });

    const data = await res.json();

    return data
      .map((country) => ({
        code: country.cca2,
        name: country.name.common,
      }))
      .sort((a, b) => a.name.localeCompare(b.name));
  } catch (error) {
    console.error("API Error:", error);
    return [];
  }
}
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### âš¡ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æˆ¦ç•¥æ¯”è¼ƒ

```mermaid
flowchart TD
SSG[Static Site Generation]
ISR[Incremental Static Regen]
SSR[Server Components]
Client[Client Components]
SSG -->|Build Time| CDN[CDN Cache Fastest]
ISR -->|Periodic Update| BG[Background Revalidate]
SSR -->|Per Request| DB[Real time Query]
Client -->|Browser| UI[User Interaction]
```

#### **SSG - ãƒ“ãƒ«ãƒ‰æ™‚ç”Ÿæˆ**

```javascript
export async function generateStaticParams() {
  const cabins = await getCabins();
  return cabins.map((cabin) => ({ cabinId: String(cabin.id) }));
}

export default async function CabinPage({ params }) {
  const cabin = await getCabin(params.cabinId);
  return <CabinDetail cabin={cabin} />;
}
```

| ç‰¹æ€§           | èª¬æ˜                   |
| -------------- | ---------------------- |
| ç”Ÿæˆã‚¿ã‚¤ãƒŸãƒ³ã‚° | npm run build æ™‚       |
| ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰   | ğŸš€ æœ€é€Ÿ CDN ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |
| ãƒ‡ãƒ¼ã‚¿æ›´æ–°     | å†ãƒ“ãƒ«ãƒ‰ãŒå¿…è¦         |
| ç”¨é€”           | å¤‰æ›´é »åº¦ãŒä½ã„ãƒšãƒ¼ã‚¸   |

#### **ISR - å®šæœŸæ›´æ–°**

```javascript
export const revalidate = 3600;

export default async function CabinsPage() {
  const cabins = await getCabins();
  return <CabinList cabins={cabins} />;
}
```

| ç‰¹æ€§           | èª¬æ˜                     |
| -------------- | ------------------------ |
| ç”Ÿæˆã‚¿ã‚¤ãƒŸãƒ³ã‚° | ãƒ“ãƒ«ãƒ‰æ™‚ + å®šæœŸæ›´æ–°      |
| ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰   | âœˆï¸ é«˜é€Ÿ ã‚­ãƒ£ãƒƒã‚·ãƒ¥       |
| ãƒ‡ãƒ¼ã‚¿æ›´æ–°     | è‡ªå‹• ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰    |
| ç”¨é€”           | å®šæœŸçš„ã«æ›´æ–°ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ |

#### **Server Components - ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¯**

```javascript
export default async function CabinList() {
  const cabins = await getCabins();
  return (
    <div>
      {cabins.map((c) => (
        <CabinCard key={c.id} cabin={c} />
      ))}
    </div>
  );
}
```

| ç‰¹æ€§           | èª¬æ˜                 |
| -------------- | -------------------- |
| ç”Ÿæˆã‚¿ã‚¤ãƒŸãƒ³ã‚° | ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¯         |
| ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰   | ğŸ‘ æ™®é€š              |
| ãƒ‡ãƒ¼ã‚¿æ›´æ–°     | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ          |
| ç”¨é€”           | å¸¸ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ |

#### **Client Components - ãƒ–ãƒ©ã‚¦ã‚¶å´**

```javascript
"use client";

import { useContext } from "react";
import { ReservationContext } from "./ReservationContext";

export default function DateSelector({ cabin }) {
  const { range, setRange } = useContext(ReservationContext);
  return <DayPicker selected={range} onSelect={setRange} />;
}
```

| ç‰¹æ€§           | èª¬æ˜                 |
| -------------- | -------------------- |
| ç”Ÿæˆã‚¿ã‚¤ãƒŸãƒ³ã‚° | ãƒ–ãƒ©ã‚¦ã‚¶å´ã§å®Ÿè¡Œ     |
| ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰   | â³ å¯å¤‰              |
| ãƒ‡ãƒ¼ã‚¿æ›´æ–°     | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚       |
| ç”¨é€”           | ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å¿…é ˆ |

### ğŸ“Š Core Web Vitals æœ€é©åŒ–

```mermaid
flowchart TD
LCP[LCP less than 2.5s]
FID[FID less than 100ms]
CLS[CLS less than 0.1]
LCP --> SSG_ISR[SSG ISR Static]
LCP --> ImageOpt[Image Optimization]
FID --> ServerComp[Server Components]
FID --> Bundle[Code Splitting]
CLS --> FixedHeight[Fixed Height Image]
CLS --> Skeleton[Skeleton Loading]
```

### ğŸ–¼ï¸ ç”»åƒæœ€é©åŒ–

```javascript
import Image from "next/image";

export default function CabinCard({ cabin }) {
  return (
    <Image
      src={cabin.image}
      alt={cabin.name}
      fill
      sizes="(max-width: 768px) 100vw, 50vw"
      className="object-cover"
      priority={false}
      quality={80}
      placeholder="blur"
    />
  );
}
```

| æœ€é©åŒ–é …ç›®             | åŠ¹æœ                |
| ---------------------- | ------------------- |
| è‡ªå‹• WebP å¤‰æ›         | -30% ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º |
| ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚µã‚¤ã‚¸ãƒ³ã‚° | ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–      |
| Lazy Loading           | åˆæœŸãƒ­ãƒ¼ãƒ‰å‰Šæ¸›      |
| blur placeholder       | CLS å‰Šæ¸›            |

---

## é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

### ğŸš€ åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰

```bash
npm run dev
npm run build
npm start
npm run lint
npm run prod
```

| ã‚³ãƒãƒ³ãƒ‰      | èª¬æ˜                        |
| ------------- | --------------------------- |
| npm run dev   | é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ |
| npm run build | æœ¬ç•ªãƒ“ãƒ«ãƒ‰ .next ç”Ÿæˆ       |
| npm start     | æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼èµ·å‹•            |
| npm run lint  | ESLint ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ         |
| npm run prod  | ãƒ“ãƒ«ãƒ‰ ã¨ èµ·å‹• ä¸€æ‹¬å®Ÿè¡Œ     |

### ğŸ“ é–‹ç™ºãƒ•ãƒ­ãƒ¼ä¾‹

```mermaid
flowchart TD
Start[Step 1 npm run dev]
Browser[Step 2 Browser localhost 3000]
Edit[Step 3 Edit Code HotReload]
Lint[Step 4 ESLint Check]
Test[Step 5 Run Tests]
Commit[Step 6 Git Commit]
Prod[Step 7 Production Deploy]
Start --> Browser
Browser --> Edit
Edit --> Lint
Lint --> Test
Test --> Commit
Commit --> Prod
```

---

## å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³é›†

### ğŸ“Œ ãƒ‘ã‚¿ãƒ¼ãƒ³ 1: Server Action æ¨™æº–å½¢

```javascript
"use server";

import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";
import { auth } from "./auth";

export async function myServerAction(formData) {
  // Step 1: èªè¨¼ãƒã‚§ãƒƒã‚¯
  const session = await auth();
  if (!session) throw new Error("èªè¨¼ãŒå¿…è¦ã§ã™");

  // Step 2: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if (!formData.title || formData.title.trim() === "") {
    throw new Error("ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™");
  }

  // Step 3: èªå¯ãƒã‚§ãƒƒã‚¯
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¨©é™ã‚’æŒã¤ã‹ç¢ºèª

  // Step 4: ãƒ‡ãƒ¼ã‚¿æ“ä½œ
  const result = await database.insert(formData);

  // Step 5: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
  revalidatePath("/path");

  // Step 6: ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  redirect("/success");
}
```

### ğŸ“Œ ãƒ‘ã‚¿ãƒ¼ãƒ³ 2: Client Component ã§ã®éåŒæœŸå‡¦ç†

```javascript
"use client";

import { useTransition } from "react";
import { updateItem } from "@/app/_lib/actions";

export function ItemUpdateForm({ item }) {
  const [isPending, startTransition] = useTransition();

  const handleUpdate = (e) => {
    e.preventDefault();

    startTransition(async () => {
      try {
        const formData = new FormData(e.currentTarget);
        await updateItem(item.id, Object.fromEntries(formData));
      } catch (error) {
        console.error("Error:", error);
      }
    });
  };

  return (
    <form onSubmit={handleUpdate}>
      <input type="text" name="title" defaultValue={item.title} />
      <button type="submit" disabled={isPending}>
        {isPending ? "Updating..." : "Update"}
      </button>
    </form>
  );
}
```

### ğŸ“Œ ãƒ‘ã‚¿ãƒ¼ãƒ³ 3: Error Boundary

```javascript
// app/error.js
"use client";

export default function Error({ error, reset }) {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="bg-white p-8 rounded-lg shadow">
        <h2 className="text-2xl font-bold text-red-600 mb-4">
          ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ
        </h2>
        <p className="text-gray-600 mb-6">{error.message}</p>
        <button
          onClick={reset}
          className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
        >
          ã‚‚ã†ä¸€åº¦è©¦ã™
        </button>
      </div>
    </div>
  );
}
```

### ğŸ“Œ ãƒ‘ã‚¿ãƒ¼ãƒ³ 4: Dynamic Imports Code Splitting

```javascript
import dynamic from "next/dynamic";
import Spinner from "./Spinner";

const InteractiveMap = dynamic(() => import("./InteractiveMap"), {
  loading: () => <Spinner />,
  ssr: false,
});

export default function CabinDetail({ cabin }) {
  return (
    <div>
      <h1>{cabin.name}</h1>
      <InteractiveMap location={cabin.location} />
    </div>
  );
}
```

### ğŸ“Œ ãƒ‘ã‚¿ãƒ¼ãƒ³ 5: Streaming with Suspense

```javascript
import { Suspense } from "react";
import CabinSkeleton from "@/app/_components/CabinSkeleton";

async function CabinContent({ cabinId }) {
  const cabin = await getCabin(cabinId);
  return <CabinDetail cabin={cabin} />;
}

async function BookingContent({ cabinId }) {
  const bookings = await getBookings(cabinId);
  return <BookingList bookings={bookings} />;
}

export default function CabinPage({ params }) {
  return (
    <div>
      <Suspense fallback={<CabinSkeleton />}>
        <CabinContent cabinId={params.cabinId} />
      </Suspense>

      <Suspense fallback={<div>Loading bookings...</div>}>
        <BookingContent cabinId={params.cabinId} />
      </Suspense>
    </div>
  );
}
```

### ğŸ“Œ ãƒ‘ã‚¿ãƒ¼ãƒ³ 6: Form Validation

```javascript
"use client";

import { useActionState } from "react";
import { createBooking } from "@/app/_lib/actions";

export function BookingForm({ cabin }) {
  const [state, formAction, isPending] = useActionState(createBooking, {
    message: "",
    errors: {},
  });

  return (
    <form action={formAction} className="space-y-4">
      <div>
        <label>ã‚²ã‚¹ãƒˆæ•°</label>
        <input
          type="number"
          name="numGuests"
          min={1}
          max={cabin.maxCapacity}
          aria-invalid={!!state.errors.numGuests}
        />
        {state.errors.numGuests && (
          <p className="text-red-600 text-sm">{state.errors.numGuests}</p>
        )}
      </div>

      <button type="submit" disabled={isPending}>
        {isPending ? "Processing..." : "Book Now"}
      </button>

      {state.message && <p className="text-green-600">{state.message}</p>}
    </form>
  );
}
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### ğŸ” èªå¯ãƒã‚§ãƒƒã‚¯ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```javascript
"use server";

import { auth } from "./auth";
import { supabaseAdmin } from "./supabase";

async function checkAuthorization(userId, resourceId) {
  const { data: resource } = await supabaseAdmin
    .from("bookings")
    .select("guestId")
    .eq("id", resourceId)
    .single();

  if (!resource || resource.guestId !== userId) {
    throw new Error("Permission denied");
  }

  return resource;
}

export async function deleteBooking(bookingId) {
  const session = await auth();
  if (!session?.user) throw new Error("Authentication required");

  await checkAuthorization(session.user.id, bookingId);

  const { data: booking } = await supabaseAdmin
    .from("bookings")
    .select("startDate, status")
    .eq("id", bookingId)
    .single();

  if (booking.status === "cancelled") {
    throw new Error("Already cancelled");
  }

  if (new Date(booking.startDate) < new Date()) {
    throw new Error("Cannot delete past bookings");
  }

  await supabaseAdmin
    .from("bookings")
    .update({ status: "cancelled" })
    .eq("id", bookingId);

  revalidatePath("/account/reservations");
}
```

### ğŸ›¡ï¸ SQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³é˜²æ­¢

```javascript
// âœ… Correct - Supabase auto escaping
export async function getBookingsByDateRange(startDate, endDate) {
  const { data } = await supabase
    .from("bookings")
    .select("*")
    .gte("startDate", startDate)
    .lte("endDate", endDate);

  return data;
}

// âŒ Wrong - String concatenation risk
export async function getBookingsDangerous(startDate, endDate) {
  const query = `
    SELECT * FROM bookings
    WHERE startDate >= '${startDate}'
    AND endDate <= '${endDate}'
  `;
}
```

### ğŸ”‘ API ã‚­ãƒ¼ç®¡ç†

```bash
## .env.local
NEXT_PUBLIC_SUPABASE_URL=https://...
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ... (public)
SUPABASE_URL=https://...
SUPABASE_SERVICE_ROLE_KEY=eyJ... (secret server only)
AUTH_GOOGLE_ID=xxx.apps.googleusercontent.com
AUTH_GOOGLE_SECRET=xxx (secret)
AUTH_SECRET=xxx (secret NextAuth)
```

---

## ãƒ†ã‚¹ãƒˆ

### ğŸ§ª Vitest ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

```javascript
// app/_lib/__tests__/data-service.test.js
import { describe, it, expect, beforeEach, vi } from "vitest";
import { getCabins, getBookedDatesByCabinId } from "../data-service";

describe("data-service", () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe("getCabins", () => {
    it("should return all cabins", async () => {
      const cabins = await getCabins();

      expect(Array.isArray(cabins)).toBe(true);
      expect(cabins.length).toBeGreaterThan(0);
      expect(cabins[0]).toHaveProperty("id");
      expect(cabins[0]).toHaveProperty("name");
    });
  });

  describe("getBookedDatesByCabinId", () => {
    it("should return booked dates for cabin", async () => {
      const dates = await getBookedDatesByCabinId(1);

      expect(Array.isArray(dates)).toBe(true);
      dates.forEach((date) => {
        expect(date instanceof Date).toBe(true);
      });
    });

    it("should return empty array if no bookings", async () => {
      const dates = await getBookedDatesByCabinId(999);
      expect(dates).toEqual([]);
    });
  });
});
```

### ğŸ§ª React Testing Library

```javascript
// app/_components/__tests__/DateSelector.test.jsx
import { render, screen, fireEvent } from "@testing-library/react";
import { ReservationProvider } from "../ReservationProvider";
import DateSelector from "../DateSelector";

describe("DateSelector", () => {
  const mockCabin = {
    id: 1,
    name: "Mountain Cabin",
  };

  it("should render calendar", () => {
    render(
      <ReservationProvider>
        <DateSelector cabin={mockCabin} bookedDates={[]} />
      </ReservationProvider>
    );

    const calendar = screen.getByRole("application");
    expect(calendar).toBeInTheDocument();
  });

  it("should select date range", async () => {
    render(
      <ReservationProvider>
        <DateSelector cabin={mockCabin} bookedDates={[]} />
      </ReservationProvider>
    );

    const startDay = screen.getByText("15");
    fireEvent.click(startDay);

    const endDay = screen.getByText("20");
    fireEvent.click(endDay);

    expect(startDay).toHaveClass("selected");
  });
});
```

### ğŸ§ª Playwright E2E ãƒ†ã‚¹ãƒˆ

```javascript
// e2e/booking.spec.ts
import { test, expect } from "@playwright/test";

test.describe("Booking Flow", () => {
  test.beforeEach(async ({ page }) => {
    await page.goto("http://localhost:3000/cabins/1");
  });

  test("should complete booking successfully", async ({ page }) => {
    const calendar = page.locator('[role="application"]');
    await calendar.waitFor();

    const startDate = page.locator('button:has-text("15")');
    await startDate.click();

    const endDate = page.locator('button:has-text("20")');
    await endDate.click();

    await page.fill('input[name="numGuests"]', "2");
    await page.fill('textarea[name="observations"]', "Special");

    await page.click('button:has-text("Book Now")');

    await expect(page).toHaveURL(/\/thankyou/);
    await expect(page.locator("h1")).toContainText("Complete");
  });

  test("should show error for past dates", async ({ page }) => {
    const pastDate = page.locator('button:has-text("01")');
    await pastDate.click();

    const error = page.locator('[role="alert"]');
    await expect(error).toContainText("cannot select");
  });
});
```

---

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

### ğŸš€ Vercel ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
npm install -g vercel

vercel login

vercel

# Environment Variables è¨­å®š
# Settings > Environment Variables
# NEXT_PUBLIC_SUPABASE_URL
# NEXT_PUBLIC_SUPABASE_ANON_KEY
# SUPABASE_URL
# SUPABASE_SERVICE_ROLE_KEY
# AUTH_GOOGLE_ID
# AUTH_GOOGLE_SECRET
# AUTH_SECRET

vercel --prod
```

### ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯

```mermaid
flowchart TD
A[ESLint Check npm run lint]
B[Build Success npm run build]
C[Env Vars Complete]
D[DB Migration Done]
E[Keys in .gitignore]
F[CORS Configured]
G[Auth Settings OK]
H[Ready to Deploy]
A --> B
B --> C
C --> D
D --> E
E --> F
F --> G
G --> H
```

| é …ç›®     | ãƒã‚§ãƒƒã‚¯             | ã‚³ãƒãƒ³ãƒ‰              |
| -------- | -------------------- | --------------------- |
| ESLint   | ã‚¨ãƒ©ãƒ¼ãªã—           | npm run lint          |
| ãƒ“ãƒ«ãƒ‰   | æˆåŠŸ                 | npm run build         |
| ç’°å¢ƒå¤‰æ•° | å®Œäº†                 | .env.production.local |
| DB       | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº† | Supabase SQL Editor   |
| Git      | ç§˜å¯†ã‚­ãƒ¼é™¤å¤–         | .gitignore ç¢ºèª       |
| CORS     | è¨­å®šå®Œäº†             | Supabase Settings     |
| OAuth    | ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®š     | Google Console        |

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ğŸ› ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±º

#### å•é¡Œ 1: Supabase èªè¨¼ã‚¨ãƒ©ãƒ¼

```
Error: Supabase client not initialized
```

**åŸå› :** ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„

**è§£æ±º:**

```bash
cat > .env.local << 'EOF'
NEXT_PUBLIC_SUPABASE_URL=your_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_key
SUPABASE_URL=your_url
SUPABASE_SERVICE_ROLE_KEY=your_key
AUTH_GOOGLE_ID=your_id
AUTH_GOOGLE_SECRET=your_secret
AUTH_SECRET=$(openssl rand -base64 32)
EOF

npm run dev
```

#### å•é¡Œ 2: Server Action ãŒå®Ÿè¡Œã•ã‚Œãªã„

```
Error: Server action not found
```

**åŸå› :** 'use server' ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–æ¬ è½

**è§£æ±º:**

```javascript
// âœ… Correct
"use server";

export async function myAction() {
  // Server Action
}

// âŒ Wrong
export async function myAction() {
  // Missing 'use server'
}
```

#### å•é¡Œ 3: ISR ãŒåæ˜ ã•ã‚Œãªã„

```
å¤ã„ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œç¶šã‘ã‚‹
```

**åŸå› :** revalidate è¨­å®šãŒãªã„

**è§£æ±º:**

```javascript
export const revalidate = 3600;

export async function updateData(data) {
  // ... æ›´æ–°å‡¦ç†
  revalidatePath("/cabins");
  revalidateTag("cabins-data");
  redirect("/cabins");
}
```

#### å•é¡Œ 4: Hydration mismatch ã‚¨ãƒ©ãƒ¼

```
Text content does not match server-rendered HTML
```

**åŸå› :** ã‚µãƒ¼ãƒãƒ¼å´ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çµæœãŒç•°ãªã‚‹

**è§£æ±º:**

```javascript
// âŒ Wrong
"use client";

export function DateDisplay() {
  return <div>{new Date().toLocaleString()}</div>;
}

// âœ… Correct
("use client");

import { useEffect, useState } from "react";

export function DateDisplay() {
  const [date, setDate] = useState("");

  useEffect(() => {
    setDate(new Date().toLocaleString());
  }, []);

  return <div>{date}</div>;
}
```

#### å•é¡Œ 5: äºˆç´„é‡è¤‡ã‚¨ãƒ©ãƒ¼

```
Error: This period is already booked
```

**åŸå› :** æ—¥ä»˜ãƒã‚§ãƒƒã‚¯ ãƒ­ã‚¸ãƒƒã‚¯ãŒä¸æ­£ç¢º

**è§£æ±º:**

```javascript
"use server";

export async function createBooking(bookingData) {
  const { data: conflicts } = await supabaseAdmin
    .from("bookings")
    .select("id")
    .eq("cabinId", bookingData.cabinId)
    .or(
      `and(` +
        `startDate.lt.${bookingData.endDate},` +
        `endDate.gt.${bookingData.startDate}` +
        `)`
    );

  if (conflicts && conflicts.length > 0) {
    throw new Error("Already booked");
  }
}
```

---

## ğŸ“š å‚è€ƒãƒªã‚½ãƒ¼ã‚¹

| ãƒªã‚½ãƒ¼ã‚¹     | URL                       | èª¬æ˜                           |
| ------------ | ------------------------- | ------------------------------ |
| Next.js å…¬å¼ | https://nextjs.org        | ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ |
| React å…¬å¼   | https://react.dev         | React æœ€æ–°æ©Ÿèƒ½è§£èª¬             |
| Supabase     | https://supabase.com/docs | PostgreSQL ãƒãƒãƒ¼ã‚¸ãƒ‰ DB       |
| NextAuth     | https://next-auth.js.org  | èªè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒª                 |
| Tailwind CSS | https://tailwindcss.com   | CSS ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯             |
| date-fns     | https://date-fns.org      | æ—¥ä»˜å‡¦ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒª             |

---

## ğŸ¯ ã¾ã¨ã‚

### âœ¨ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç‰¹å¾´

```mermaid
flowchart TD
Perf[ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–]
Scale[ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£]
DevExp[é–‹ç™ºåŠ¹ç‡]
Secure[ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£]
Perf -->|SSG ISR| Fast[è¶…é«˜é€Ÿé…ä¿¡]
Scale -->|PostgreSQL| Data[å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿]
DevExp -->|TypeScript| Type[å‹å®‰å…¨]
Secure -->|OAuth| Auth[èªå¯åˆ¶å¾¡]
```

**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹:** SSG/ISR ã§é™çš„é…ä¿¡ã€Server Components ã§ãƒãƒ³ãƒ‰ãƒ«å‰Šæ¸›

**ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£:** Supabase PostgreSQL ã§ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºå¯¾å¿œ

**é–‹ç™ºåŠ¹ç‡:** Next.js 14 App Router ã§ç›´æ„Ÿçš„ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:** NextAuth v5 + èªå¯ãƒã‚§ãƒƒã‚¯ã§å …ç‰¢æ€§ç¢ºä¿

---

**æœ€çµ‚æ›´æ–°:** 2025 å¹´ 10 æœˆ 19 æ—¥
